"use strict";
class FairSocket {
    stompClient;
    userData = new UserData();
    state = Vue.reactive({
        connected: false,
        connectionRequested: false,
    });
    constructor() {
        this.stompClient = StompJs.Stomp.over(() => new SockJS('https://fair.kaliburg.de/fairsocket'));
        if (!localStorage.getItem('stompClient.debug')) {
            this.stompClient.debug = () => { };
        }
        for (let k of [
            'onChangeState',
            'onConnect',
            'onDisconnect',
            'onStompError',
            'onUnhandledFrame',
            'onUnhandledMessage',
            'onUnhandledReceipt',
            'onWebSocketClose',
            'onWebSocketError',
        ]) {
            // just logging everything
            this.stompClient[k] = (...a) => {
                if (localStorage.getItem('stompClient.debug.events'))
                    console.warn(k, ...a);
                this[k]?.(...a);
            };
        }
        window.addEventListener('onbeforeunload', () => this.disconnect());
    }
    _resolveOnConnected = [];
    async connect() {
        this.state.connectionRequested = true;
        await new Promise(resolve => {
            if (this.stompClient.connected) {
                resolve();
            }
            else {
                this._resolveOnConnected.push(resolve);
                this.stompClient.connect({}, this.stompClient.onConnect);
            }
        });
        let _resolve;
        this.subscribe('/user/queue/account/login', (data) => {
            if (data.status != 'OK') {
                alert('Failed to login!');
                throw 0;
            }
            console.log('login succeed!', data.content);
            this.userData.chatNum = data.content.highestCurrentLadder;
            this.userData.ladderNum = data.content.highestCurrentLadder;
            antd.message.success(`Highest ladder: #${data.content.highestCurrentLadder}`, 10);
            antd.message.success(`Connected to server as user#${data.content.accountId}`, 10);
            _resolve();
        }, { uuid: this.userData.uuid });
        await new Promise(resolve => {
            _resolve = resolve;
            this.send('/app/account/login', { uuid: this.userData.uuid });
        });
    }
    disconnect() {
        this.stompClient.disconnect();
        this.state.connectionRequested = false;
        this.state.connected = false;
    }
    onConnect() {
        this.state.connectionRequested = false;
        this.state.connected = true;
        this._resolveOnConnected.map(e => e());
        this._resolveOnConnected = [];
    }
    send(destination, data, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        if (localStorage.getItem('stompClient.debug.send'))
            console.warn('Send', destination, data);
        this.stompClient.send(destination, {}, JSON.stringify(data));
    }
    subscribe(destination, listener, request, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        if (localStorage.getItem('stompClient.debug.subscribe'))
            console.warn('Subscribed to', destination);
        return this.stompClient.subscribe(destination, (message) => {
            let data = JSON.parse(message.body || 'null');
            if (localStorage.getItem('stompClient.debug.subscribe.event'))
                console.warn(destination, data, message);
            listener(data);
        }, request);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvbXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQXlJQSxNQUFNLFVBQVU7SUFDZixXQUFXLENBQXVCO0lBQ2xDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFCLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLG1CQUFtQixFQUFFLEtBQUs7S0FDMUIsQ0FBQyxDQUFDO0lBQ0g7UUFDQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLHFDQUFxQyxDQUFDLENBQUMsQ0FBQztRQUMvRixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNuQztRQUNELEtBQUssSUFBSSxDQUFDLElBQUk7WUFDYixlQUFlO1lBQ2YsV0FBVztZQUNYLGNBQWM7WUFDZCxjQUFjO1lBQ2Qsa0JBQWtCO1lBQ2xCLG9CQUFvQjtZQUNwQixvQkFBb0I7WUFDcEIsa0JBQWtCO1lBQ2xCLGtCQUFrQjtTQUNULEVBQUU7WUFDWCwwQkFBMEI7WUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlCLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQztvQkFDbkQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxQixDQUFDLENBQUE7U0FDRDtRQUNE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QyxXQUFXLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUMxRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLENBQUM7WUFDOUMsSUFBSSxZQUFZLENBQUMsT0FBTyxDQUFDLG1DQUFtQyxDQUFDO2dCQUM1RCxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDMUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hCLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbIlxyXG50eXBlIERlY2ltYWxTdHJpbmcgPSBzdHJpbmcgJiB7IF8/OiAnRGVjaW1hbFN0cmluZycgfTtcclxuXHJcbnR5cGUgX0NvbnN0cnVjdEV2ZW50PEV2VHlwZSBleHRlbmRzIHN0cmluZywgRGF0YSBleHRlbmRzIHt9PiA9XHJcblx0fCB7IGV2ZW50VHlwZTogRXZUeXBlIH0gJiBEYXRhO1xyXG5pbnRlcmZhY2UgU29ja2V0TGFkZGVyRXZlbnRNYXAge1xyXG5cdEJJQVM6IHtcclxuXHRcdGV2ZW50VHlwZTogJ0JJQVMnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRNVUxUSToge1xyXG5cdFx0ZXZlbnRUeXBlOiAnTVVMVEknLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRWSU5FR0FSOiB7XHJcblx0XHRldmVudFR5cGU6ICdWSU5FR0FSJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdFx0ZGF0YToge1xyXG5cdFx0XHRhbW91bnQ6IERlY2ltYWxTdHJpbmcsXHJcblx0XHRcdHN1Y2Nlc3M6IGJvb2xlYW4sXHJcblx0XHR9XHJcblx0fTtcclxuXHRTT0ZUX1JFU0VUX1BPSU5UUzoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnU09GVF9SRVNFVF9QT0lOVFMnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRQUk9NT1RFOiB7XHJcblx0XHRldmVudFR5cGU6ICdQUk9NT1RFJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdH07XHJcblx0QVVUT19QUk9NT1RFOiB7XHJcblx0XHRldmVudFR5cGU6ICdBVVRPX1BST01PVEUnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRKT0lOOiB7XHJcblx0XHRldmVudFR5cGU6ICdKT0lOJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdFx0ZGF0YToge1xyXG5cdFx0XHR1c2VybmFtZTogc3RyaW5nLFxyXG5cdFx0fVxyXG5cdH07XHJcblx0TkFNRV9DSEFOR0U6IHtcclxuXHRcdGV2ZW50VHlwZTogJ05BTUVfQ0hBTkdFJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdFx0ZGF0YTogc3RyaW5nLFxyXG5cdH07XHJcblx0UkVTRVQ6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1JFU0VUJyxcclxuXHR9O1xyXG59XHJcbnR5cGUgU29ja2V0TGFkZGVyRXZlbnQgPSBTb2NrZXRMYWRkZXJFdmVudE1hcFtrZXlvZiBTb2NrZXRMYWRkZXJFdmVudE1hcF07XHJcbmludGVyZmFjZSBTb2NrZXRDaGF0TWVzc2FnZSB7XHJcblx0dXNlcm5hbWU6IHN0cmluZztcclxuXHRhY2NvdW50SWQ6IGFjY291bnRJZDtcclxuXHRtZXNzYWdlOiBzdHJpbmc7XHJcblx0dGltZUNyZWF0ZWQ6IHN0cmluZztcclxuXHR0aW1lc0Fzc2hvbGU6IG51bWJlcjtcclxufVxyXG5pbnRlcmZhY2UgU29ja2V0UmFua2VyIHtcclxuXHRhY2NvdW50SWQ6IGFjY291bnRJZDtcclxuXHRiaWFzOiBudW1iZXI7XHJcblx0Z3Jvd2luZzogYm9vbGVhbjtcclxuXHRtdWx0aXBsaWVyOiBudW1iZXI7XHJcblx0cG9pbnRzOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHBvd2VyOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHJhbms6IG51bWJlcjtcclxuXHR0aW1lc0Fzc2hvbGU6IG51bWJlcjtcclxuXHR1c2VybmFtZTogc3RyaW5nO1xyXG5cdHlvdTogYm9vbGVhbjtcclxufVxyXG5pbnRlcmZhY2UgU29ja2V0WW91UmFua2VyIGV4dGVuZHMgU29ja2V0UmFua2VyIHtcclxuXHRhdXRvUHJvbW90ZTogYm9vbGVhbjtcclxuXHRncmFwZXM6IERlY2ltYWxTdHJpbmc7XHJcblx0dmluZWdhcjogRGVjaW1hbFN0cmluZztcclxuXHR5b3U6IHRydWU7XHJcbn1cclxuXHJcblxyXG5pbnRlcmZhY2UgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwIHtcclxuXHQnL2FwcC9hY2NvdW50L2xvZ2luJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvYWNjb3VudC9uYW1lJzogeyB1dWlkOiB1dWlkLCBjb250ZW50OiBzdHJpbmcgJiB7IF8/OiAnbmV3VXNlcm5hbWUnIH0gfSxcclxuXHQnL2FwcC9jaGF0L2luaXQvJGxhZGRlck51bSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2NoYXQvcG9zdC8kY3VycmVudENoYXROdW1iZXInOiB7IHV1aWQ6IHV1aWQsIGNvbnRlbnQ6IHN0cmluZyAmIHsgXz86ICdtZXNzYWdlJyB9IH0sXHJcblx0Jy9hcHAvaW5mbyc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9pbml0LyRsYWRkZXJOdW0nOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9hc3Nob2xlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvYXV0by1wcm9tb3RlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvYmlhcyc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L211bHRpJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvcHJvbW90ZSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L3ZpbmVnYXInOiB7IHV1aWQ6IHV1aWQgfSxcclxufVxyXG5cclxuaW50ZXJmYWNlIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcCB7XHJcblx0Jy90b3BpYy9jaGF0LyRsYWRkZXJOdW0nOiBTb2NrZXRDaGF0TWVzc2FnZSxcclxuXHQnL3RvcGljL2xhZGRlci8kbGFkZGVyTnVtJzogeyBldmVudHM6IFNvY2tldExhZGRlckV2ZW50W10sIHNlY29uZHNQYXNzZWQ6IG51bWJlciB9LFxyXG5cdCcvdXNlci9xdWV1ZS9hY2NvdW50L2xvZ2luJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJ0NSRUFURUQnIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHR1dWlkOiB1dWlkLCBhY2NvdW50SWQ6IG51bWJlciwgaGlnaGVzdEN1cnJlbnRMYWRkZXI6IG51bWJlcixcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9jaGF0Lyc6IHtcclxuXHRcdHN0YXR1czogJ09LJyB8ICc/JyxcclxuXHRcdGNvbnRlbnQ6IHtcclxuXHRcdFx0Y3VycmVudENoYXROdW1iZXI6IG51bWJlcixcclxuXHRcdFx0bWVzc2FnZXM6IFNvY2tldENoYXRNZXNzYWdlW10sXHJcblx0XHR9XHJcblx0fSxcclxuXHQnL3VzZXIvcXVldWUvaW5mbyc6IHtcclxuXHRcdHN0YXR1czogJ09LJyB8ICc/JyxcclxuXHRcdGNvbnRlbnQ6IHtcclxuXHRcdFx0YXNzaG9sZUxhZGRlcjogbnVtYmVyLFxyXG5cdFx0XHRhc3Nob2xlVGFnczogc3RyaW5nW10sXHJcblx0XHRcdGF1dG9Qcm9tb3RlTGFkZGVyOiBudW1iZXIsXHJcblx0XHRcdGJhc2VHcmFwZXNOZWVkZWRUb0F1dG9Qcm9tb3RlOiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0XHRiYXNlVmluZWdhck5lZWRlZFRvVGhyb3c6IERlY2ltYWxTdHJpbmcsXHJcblx0XHRcdG1hbnVhbFByb21vdGVXYWl0VGltZTogbnVtYmVyLFxyXG5cdFx0XHRtaW5pbXVtUGVvcGxlRm9yUHJvbW90ZTogbnVtYmVyLFxyXG5cdFx0XHRwb2ludHNGb3JQcm9tb3RlOiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0fVxyXG5cdH0sXHJcblx0Jy91c2VyL3F1ZXVlL2xhZGRlci8nOiB7XHJcblx0XHRzdGF0dXM6ICdPSycgfCAnPycsXHJcblx0XHRjb250ZW50OiB7XHJcblx0XHRcdGN1cnJlbnRMYWRkZXI6IHsgbnVtYmVyOiBudW1iZXIgfSxcclxuXHRcdFx0Zmlyc3RSYW5rZXI6IFNvY2tldFJhbmtlcixcclxuXHRcdFx0eW91clJhbmtlcjogU29ja2V0WW91UmFua2VyLFxyXG5cdFx0XHRyYW5rZXJzOiBTb2NrZXRSYW5rZXJbXSxcclxuXHRcdFx0c3RhcnRSYW5rOiBudW1iZXIsXHJcblx0XHR9XHJcblx0fSxcclxuXHQnL3VzZXIvcXVldWUvbGFkZGVyL3VwZGF0ZXMnOiB7XHJcblx0XHRldmVudHM6IFNvY2tldExhZGRlckV2ZW50W10sXHJcblx0fSxcclxufVxyXG5cclxuY2xhc3MgRmFpclNvY2tldCB7XHJcblx0c3RvbXBDbGllbnQ6IFN0b21wSnMuQ29tcGF0Q2xpZW50O1xyXG5cdHVzZXJEYXRhID0gbmV3IFVzZXJEYXRhKCk7XHJcblx0c3RhdGUgPSBWdWUucmVhY3RpdmUoe1xyXG5cdFx0Y29ubmVjdGVkOiBmYWxzZSxcclxuXHRcdGNvbm5lY3Rpb25SZXF1ZXN0ZWQ6IGZhbHNlLFxyXG5cdH0pO1xyXG5cdGNvbnN0cnVjdG9yKCkge1xyXG5cdFx0dGhpcy5zdG9tcENsaWVudCA9IFN0b21wSnMuU3RvbXAub3ZlcigoKSA9PiBuZXcgU29ja0pTKCdodHRwczovL2ZhaXIua2FsaWJ1cmcuZGUvZmFpcnNvY2tldCcpKTtcclxuXHRcdGlmICghbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N0b21wQ2xpZW50LmRlYnVnJykpIHtcclxuXHRcdFx0dGhpcy5zdG9tcENsaWVudC5kZWJ1ZyA9ICgpID0+IHsgfTtcclxuXHRcdH1cclxuXHRcdGZvciAobGV0IGsgb2YgW1xyXG5cdFx0XHQnb25DaGFuZ2VTdGF0ZScsXHJcblx0XHRcdCdvbkNvbm5lY3QnLFxyXG5cdFx0XHQnb25EaXNjb25uZWN0JyxcclxuXHRcdFx0J29uU3RvbXBFcnJvcicsXHJcblx0XHRcdCdvblVuaGFuZGxlZEZyYW1lJyxcclxuXHRcdFx0J29uVW5oYW5kbGVkTWVzc2FnZScsXHJcblx0XHRcdCdvblVuaGFuZGxlZFJlY2VpcHQnLFxyXG5cdFx0XHQnb25XZWJTb2NrZXRDbG9zZScsXHJcblx0XHRcdCdvbldlYlNvY2tldEVycm9yJyxcclxuXHRcdF0gYXMgY29uc3QpIHtcclxuXHRcdFx0Ly8ganVzdCBsb2dnaW5nIGV2ZXJ5dGhpbmdcclxuXHRcdFx0dGhpcy5zdG9tcENsaWVudFtrXSA9ICguLi5hKSA9PiB7XHJcblx0XHRcdFx0aWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzdG9tcENsaWVudC5kZWJ1Zy5ldmVudHMnKSlcclxuXHRcdFx0XHRcdGNvbnNvbGUud2FybihrLCAuLi5hKTtcclxuXHRcdFx0XHQodGhpcyBhcyBhbnkpW2tdPy4oLi4uYSk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHRcdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmJlZm9yZXVubG9hZCcsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcclxuXHR9XHJcblx0X3Jlc29sdmVPbkNvbm5lY3RlZDogKCgpID0+IHZvaWQpW10gPSBbXTtcclxuXHRhc3luYyBjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0aW9uUmVxdWVzdGVkID0gdHJ1ZTtcclxuXHRcdGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xyXG5cdFx0XHRpZiAodGhpcy5zdG9tcENsaWVudC5jb25uZWN0ZWQpIHtcclxuXHRcdFx0XHRyZXNvbHZlKCk7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0dGhpcy5fcmVzb2x2ZU9uQ29ubmVjdGVkLnB1c2gocmVzb2x2ZSk7XHJcblx0XHRcdFx0dGhpcy5zdG9tcENsaWVudC5jb25uZWN0KHt9LCB0aGlzLnN0b21wQ2xpZW50Lm9uQ29ubmVjdCk7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdFx0bGV0IF9yZXNvbHZlOiAoKSA9PiB2b2lkO1xyXG5cdFx0dGhpcy5zdWJzY3JpYmUoJy91c2VyL3F1ZXVlL2FjY291bnQvbG9naW4nLCAoZGF0YSkgPT4ge1xyXG5cdFx0XHRpZiAoZGF0YS5zdGF0dXMgIT0gJ09LJykge1xyXG5cdFx0XHRcdGFsZXJ0KCdGYWlsZWQgdG8gbG9naW4hJyk7XHJcblx0XHRcdFx0dGhyb3cgMDtcclxuXHRcdFx0fVxyXG5cdFx0XHRjb25zb2xlLmxvZygnbG9naW4gc3VjY2VlZCEnLCBkYXRhLmNvbnRlbnQpO1xyXG5cdFx0XHR0aGlzLnVzZXJEYXRhLmNoYXROdW0gPSBkYXRhLmNvbnRlbnQuaGlnaGVzdEN1cnJlbnRMYWRkZXI7XHJcblx0XHRcdHRoaXMudXNlckRhdGEubGFkZGVyTnVtID0gZGF0YS5jb250ZW50LmhpZ2hlc3RDdXJyZW50TGFkZGVyO1xyXG5cdFx0XHRhbnRkLm1lc3NhZ2Uuc3VjY2VzcyhcclxuXHRcdFx0XHRgSGlnaGVzdCBsYWRkZXI6ICMke2RhdGEuY29udGVudC5oaWdoZXN0Q3VycmVudExhZGRlcn1gLCAxMFxyXG5cdFx0XHQpO1xyXG5cdFx0XHRhbnRkLm1lc3NhZ2Uuc3VjY2VzcyhcclxuXHRcdFx0XHRgQ29ubmVjdGVkIHRvIHNlcnZlciBhcyB1c2VyIyR7ZGF0YS5jb250ZW50LmFjY291bnRJZH1gLCAxMFxyXG5cdFx0XHQpO1xyXG5cdFx0XHRfcmVzb2x2ZSgpO1xyXG5cdFx0fSwgeyB1dWlkOiB0aGlzLnVzZXJEYXRhLnV1aWQgfSk7XHJcblx0XHRhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPihyZXNvbHZlID0+IHtcclxuXHRcdFx0X3Jlc29sdmUgPSByZXNvbHZlO1xyXG5cdFx0XHR0aGlzLnNlbmQoJy9hcHAvYWNjb3VudC9sb2dpbicsIHsgdXVpZDogdGhpcy51c2VyRGF0YS51dWlkIH0pO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cdGRpc2Nvbm5lY3QoKSB7XHJcblx0XHR0aGlzLnN0b21wQ2xpZW50LmRpc2Nvbm5lY3QoKTtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGlvblJlcXVlc3RlZCA9IGZhbHNlO1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0ZWQgPSBmYWxzZTtcclxuXHR9XHJcblx0b25Db25uZWN0KCkge1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0aW9uUmVxdWVzdGVkID0gZmFsc2U7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3RlZCA9IHRydWU7XHJcblx0XHR0aGlzLl9yZXNvbHZlT25Db25uZWN0ZWQubWFwKGUgPT4gZSgpKTtcclxuXHRcdHRoaXMuX3Jlc29sdmVPbkNvbm5lY3RlZCA9IFtdO1xyXG5cdH1cclxuXHJcblx0c2VuZDxLIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXAsIGAke3N0cmluZ30kJHtzdHJpbmd9YD4+KGRlc3RpbmF0aW9uOiBLLCBkYXRhOiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXBbS10sIG51bWJlcjogbnVtYmVyKTogdm9pZDtcclxuXHRzZW5kPEsgZXh0ZW5kcyBFeGNsdWRlPGtleW9mIEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGRhdGE6IEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcFtLXSk6IHZvaWQ7XHJcblx0c2VuZDxLIGV4dGVuZHMga2V5b2YgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwPihkZXN0aW5hdGlvbjogSywgZGF0YTogRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwW0tdLCBudW1iZXI/OiBudW1iZXIpIHtcclxuXHRcdGlmIChkZXN0aW5hdGlvbi5pbmNsdWRlcygnJCcpKSB7XHJcblx0XHRcdGlmIChudW1iZXIgPT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0XHRkZXN0aW5hdGlvbiA9IGAke2Rlc3RpbmF0aW9uLnNwbGl0KCckJylbMF19JHtudW1iZXJ9YCBhcyBhbnk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRpZiAobnVtYmVyICE9IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgdXNhZ2UnKTtcclxuXHRcdH1cclxuXHRcdGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvbXBDbGllbnQuZGVidWcuc2VuZCcpKVxyXG5cdFx0XHRjb25zb2xlLndhcm4oJ1NlbmQnLCBkZXN0aW5hdGlvbiwgZGF0YSk7XHJcblx0XHR0aGlzLnN0b21wQ2xpZW50LnNlbmQoZGVzdGluYXRpb24sIHt9LCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcblx0fVxyXG5cdHN1YnNjcmliZTxLIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXAsIGAke3N0cmluZ30kJHtzdHJpbmd9YD4+KGRlc3RpbmF0aW9uOiBLLCBsaXN0ZW5lcjogKGRhdGE6IEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcFtLXSkgPT4gdm9pZCwgcmVxdWVzdDogeyB1dWlkOiB1dWlkIH0sIG51bWJlcjogbnVtYmVyKTogU3RvbXBKcy5TdG9tcFN1YnNjcmlwdGlvbjtcclxuXHRzdWJzY3JpYmU8SyBleHRlbmRzIEV4Y2x1ZGU8a2V5b2YgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwLCBgJHtzdHJpbmd9JCR7c3RyaW5nfWA+PihkZXN0aW5hdGlvbjogSywgbGlzdGVuZXI6IChkYXRhOiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXBbS10pID0+IHZvaWQsIHJlcXVlc3Q6IHsgdXVpZDogdXVpZCB9KTogU3RvbXBKcy5TdG9tcFN1YnNjcmlwdGlvbjtcclxuXHRzdWJzY3JpYmU8SyBleHRlbmRzIGtleW9mIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcD4oZGVzdGluYXRpb246IEssIGxpc3RlbmVyOiAoZGF0YTogRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwW0tdKSA9PiB2b2lkLCByZXF1ZXN0OiB7IHV1aWQ6IHV1aWQgfSwgbnVtYmVyPzogbnVtYmVyKSB7XHJcblx0XHRpZiAoZGVzdGluYXRpb24uaW5jbHVkZXMoJyQnKSkge1xyXG5cdFx0XHRpZiAobnVtYmVyID09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgdXNhZ2UnKTtcclxuXHRcdFx0ZGVzdGluYXRpb24gPSBgJHtkZXN0aW5hdGlvbi5zcGxpdCgnJCcpWzBdfSR7bnVtYmVyfWAgYXMgYW55O1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0aWYgKG51bWJlciAhPSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignYmFkIHVzYWdlJyk7XHJcblx0XHR9XHJcblx0XHRpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N0b21wQ2xpZW50LmRlYnVnLnN1YnNjcmliZScpKVxyXG5cdFx0XHRjb25zb2xlLndhcm4oJ1N1YnNjcmliZWQgdG8nLCBkZXN0aW5hdGlvbik7XHJcblx0XHRyZXR1cm4gdGhpcy5zdG9tcENsaWVudC5zdWJzY3JpYmUoZGVzdGluYXRpb24sIChtZXNzYWdlKSA9PiB7XHJcblx0XHRcdGxldCBkYXRhID0gSlNPTi5wYXJzZShtZXNzYWdlLmJvZHkgfHwgJ251bGwnKTtcclxuXHRcdFx0aWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzdG9tcENsaWVudC5kZWJ1Zy5zdWJzY3JpYmUuZXZlbnQnKSlcclxuXHRcdFx0XHRjb25zb2xlLndhcm4oZGVzdGluYXRpb24sIGRhdGEsIG1lc3NhZ2UpO1xyXG5cdFx0XHRsaXN0ZW5lcihkYXRhKTtcclxuXHRcdH0sIHJlcXVlc3QpO1xyXG5cdH1cclxufVxyXG4iXX0=