"use strict";
class FairSocket {
    stompClient;
    userData = new UserData();
    state = Vue.reactive({
        connected: false,
        connectionRequested: false,
    });
    constructor() {
        this.stompClient = StompJs.Stomp.over(() => new SockJS('https://fair.kaliburg.de/fairsocket'));
        if (!localStorage.getItem('stompClient.debug')) {
            this.stompClient.debug = () => { };
        }
        for (let k of [
            'onChangeState',
            'onConnect',
            'onDisconnect',
            'onStompError',
            'onUnhandledFrame',
            'onUnhandledMessage',
            'onUnhandledReceipt',
            'onWebSocketClose',
            'onWebSocketError',
        ]) {
            // just logging everything
            this.stompClient[k] = (...a) => {
                if (localStorage.getItem('stompClient.debug.events'))
                    console.warn(k, ...a);
                this[k]?.(...a);
            };
        }
        window.addEventListener('onbeforeunload', () => this.disconnect());
    }
    _resolveOnConnected = [];
    connect() {
        this.state.connectionRequested = true;
        return new Promise(resolve => {
            if (this.stompClient.connected) {
                resolve();
            }
            else {
                this._resolveOnConnected.push(resolve);
                this.stompClient.connect({}, this.stompClient.onConnect);
            }
        });
    }
    disconnect() {
        this.stompClient.disconnect();
        this.state.connectionRequested = false;
        this.state.connected = false;
    }
    onConnect() {
        this.state.connectionRequested = false;
        this.state.connected = true;
        this._resolveOnConnected.map(e => e());
    }
    send(destination, data, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        if (localStorage.getItem('stompClient.debug.send'))
            console.warn('Send', destination, data);
        this.stompClient.send(destination, {}, JSON.stringify(data));
    }
    subscribe(destination, listener, request, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        if (localStorage.getItem('stompClient.debug.subscribe'))
            console.warn('Subscribed to', destination);
        return this.stompClient.subscribe(destination, (message) => {
            let data = JSON.parse(message.body || 'null');
            if (localStorage.getItem('stompClient.debug.subscribe.event'))
                console.warn(destination, data, message);
            listener(data);
        }, request);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvbXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQXlJQSxNQUFNLFVBQVU7SUFDZixXQUFXLENBQXVCO0lBQ2xDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFCLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLG1CQUFtQixFQUFFLEtBQUs7S0FDMUIsQ0FBQyxDQUFDO0lBQ0g7UUFDQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLHFDQUFxQyxDQUFDLENBQUMsQ0FBQztRQUMvRixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNuQztRQUNELEtBQUssSUFBSSxDQUFDLElBQUk7WUFDYixlQUFlO1lBQ2YsV0FBVztZQUNYLGNBQWM7WUFDZCxjQUFjO1lBQ2Qsa0JBQWtCO1lBQ2xCLG9CQUFvQjtZQUNwQixvQkFBb0I7WUFDcEIsa0JBQWtCO1lBQ2xCLGtCQUFrQjtTQUNULEVBQUU7WUFDWCwwQkFBMEI7WUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlCLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQztvQkFDbkQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxQixDQUFDLENBQUE7U0FDRDtRQUNE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QUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQzFELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsQ0FBQztZQUM5QyxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsbUNBQW1DLENBQUM7Z0JBQzVELE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMxQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEIsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2IsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbnR5cGUgRGVjaW1hbFN0cmluZyA9IHN0cmluZyAmIHsgXz86ICdEZWNpbWFsU3RyaW5nJyB9O1xyXG5cclxudHlwZSBfQ29uc3RydWN0RXZlbnQ8RXZUeXBlIGV4dGVuZHMgc3RyaW5nLCBEYXRhIGV4dGVuZHMge30+ID1cclxuXHR8IHsgZXZlbnRUeXBlOiBFdlR5cGUgfSAmIERhdGE7XHJcbmludGVyZmFjZSBTb2NrZXRMYWRkZXJFdmVudE1hcCB7XHJcblx0QklBUzoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnQklBUycsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdE1VTFRJOiB7XHJcblx0XHRldmVudFR5cGU6ICdNVUxUSScsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdFZJTkVHQVI6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1ZJTkVHQVInLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0XHRkYXRhOiB7XHJcblx0XHRcdGFtb3VudDogRGVjaW1hbFN0cmluZyxcclxuXHRcdFx0c3VjY2VzczogYm9vbGVhbixcclxuXHRcdH1cclxuXHR9O1xyXG5cdFNPRlRfUkVTRVRfUE9JTlRTOiB7XHJcblx0XHRldmVudFR5cGU6ICdTT0ZUX1JFU0VUX1BPSU5UUycsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdFBST01PVEU6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1BST01PVEUnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRBVVRPX1BST01PVEU6IHtcclxuXHRcdGV2ZW50VHlwZTogJ0FVVE9fUFJPTU9URScsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdEpPSU46IHtcclxuXHRcdGV2ZW50VHlwZTogJ0pPSU4nLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0XHRkYXRhOiB7XHJcblx0XHRcdHVzZXJuYW1lOiBzdHJpbmcsXHJcblx0XHR9XHJcblx0fTtcclxuXHROQU1FX0NIQU5HRToge1xyXG5cdFx0ZXZlbnRUeXBlOiAnTkFNRV9DSEFOR0UnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0XHRkYXRhOiBzdHJpbmcsXHJcblx0fTtcclxuXHRSRVNFVDoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnUkVTRVQnLFxyXG5cdH07XHJcbn1cclxudHlwZSBTb2NrZXRMYWRkZXJFdmVudCA9IFNvY2tldExhZGRlckV2ZW50TWFwW2tleW9mIFNvY2tldExhZGRlckV2ZW50TWFwXTtcclxuaW50ZXJmYWNlIFNvY2tldENoYXRNZXNzYWdlIHtcclxuXHR1c2VybmFtZTogc3RyaW5nO1xyXG5cdGFjY291bnRJZDogYWNjb3VudElkO1xyXG5cdG1lc3NhZ2U6IHN0cmluZztcclxuXHR0aW1lQ3JlYXRlZDogc3RyaW5nO1xyXG5cdHRpbWVzQXNzaG9sZTogbnVtYmVyO1xyXG59XHJcbmludGVyZmFjZSBTb2NrZXRSYW5rZXIge1xyXG5cdGFjY291bnRJZDogYWNjb3VudElkO1xyXG5cdGJpYXM6IG51bWJlcjtcclxuXHRncm93aW5nOiBib29sZWFuO1xyXG5cdG11bHRpcGxpZXI6IG51bWJlcjtcclxuXHRwb2ludHM6IERlY2ltYWxTdHJpbmc7XHJcblx0cG93ZXI6IERlY2ltYWxTdHJpbmc7XHJcblx0cmFuazogbnVtYmVyO1xyXG5cdHRpbWVzQXNzaG9sZTogbnVtYmVyO1xyXG5cdHVzZXJuYW1lOiBzdHJpbmc7XHJcblx0eW91OiBib29sZWFuO1xyXG59XHJcbmludGVyZmFjZSBTb2NrZXRZb3VSYW5rZXIgZXh0ZW5kcyBTb2NrZXRSYW5rZXIge1xyXG5cdGF1dG9Qcm9tb3RlOiBib29sZWFuO1xyXG5cdGdyYXBlczogRGVjaW1hbFN0cmluZztcclxuXHR2aW5lZ2FyOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHlvdTogdHJ1ZTtcclxufVxyXG5cclxuXHJcbmludGVyZmFjZSBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXAge1xyXG5cdCcvYXBwL2FjY291bnQvbG9naW4nOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9hY2NvdW50L25hbWUnOiB7IHV1aWQ6IHV1aWQsIGNvbnRlbnQ6IHN0cmluZyAmIHsgXz86ICduZXdVc2VybmFtZScgfSB9LFxyXG5cdCcvYXBwL2NoYXQvaW5pdC8kbGFkZGVyTnVtJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvY2hhdC9wb3N0LyRjdXJyZW50Q2hhdE51bWJlcic6IHsgdXVpZDogdXVpZCwgY29udGVudDogc3RyaW5nICYgeyBfPzogJ21lc3NhZ2UnIH0gfSxcclxuXHQnL2FwcC9pbmZvJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL2luaXQvJGxhZGRlck51bSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L2Fzc2hvbGUnOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9hdXRvLXByb21vdGUnOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9iaWFzJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvbXVsdGknOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9wcm9tb3RlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvdmluZWdhcic6IHsgdXVpZDogdXVpZCB9LFxyXG59XHJcblxyXG5pbnRlcmZhY2UgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwIHtcclxuXHQnL3RvcGljL2NoYXQvJGxhZGRlck51bSc6IFNvY2tldENoYXRNZXNzYWdlLFxyXG5cdCcvdG9waWMvbGFkZGVyLyRsYWRkZXJOdW0nOiB7IGV2ZW50czogU29ja2V0TGFkZGVyRXZlbnRbXSwgc2Vjb25kc1Bhc3NlZDogbnVtYmVyIH0sXHJcblx0Jy91c2VyL3F1ZXVlL2FjY291bnQvbG9naW4nOiB7XHJcblx0XHRzdGF0dXM6ICdPSycgfCAnQ1JFQVRFRCcgfCAnPycsXHJcblx0XHRjb250ZW50OiB7XHJcblx0XHRcdHV1aWQ6IHV1aWQsIGFjY291bnRJZDogbnVtYmVyLCBoaWdoZXN0Q3VycmVudExhZGRlcjogbnVtYmVyLFxyXG5cdFx0fVxyXG5cdH0sXHJcblx0Jy91c2VyL3F1ZXVlL2NoYXQvJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHRjdXJyZW50Q2hhdE51bWJlcjogbnVtYmVyLFxyXG5cdFx0XHRtZXNzYWdlczogU29ja2V0Q2hhdE1lc3NhZ2VbXSxcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9pbmZvJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHRhc3Nob2xlTGFkZGVyOiBudW1iZXIsXHJcblx0XHRcdGFzc2hvbGVUYWdzOiBzdHJpbmdbXSxcclxuXHRcdFx0YXV0b1Byb21vdGVMYWRkZXI6IG51bWJlcixcclxuXHRcdFx0YmFzZUdyYXBlc05lZWRlZFRvQXV0b1Byb21vdGU6IERlY2ltYWxTdHJpbmcsXHJcblx0XHRcdGJhc2VWaW5lZ2FyTmVlZGVkVG9UaHJvdzogRGVjaW1hbFN0cmluZyxcclxuXHRcdFx0bWFudWFsUHJvbW90ZVdhaXRUaW1lOiBudW1iZXIsXHJcblx0XHRcdG1pbmltdW1QZW9wbGVGb3JQcm9tb3RlOiBudW1iZXIsXHJcblx0XHRcdHBvaW50c0ZvclByb21vdGU6IERlY2ltYWxTdHJpbmcsXHJcblx0XHR9XHJcblx0fSxcclxuXHQnL3VzZXIvcXVldWUvbGFkZGVyLyc6IHtcclxuXHRcdHN0YXR1czogJ09LJyB8ICc/JyxcclxuXHRcdGNvbnRlbnQ6IHtcclxuXHRcdFx0Y3VycmVudExhZGRlcjogeyBudW1iZXI6IG51bWJlciB9LFxyXG5cdFx0XHRmaXJzdFJhbmtlcjogU29ja2V0UmFua2VyLFxyXG5cdFx0XHR5b3VyUmFua2VyOiBTb2NrZXRZb3VSYW5rZXIsXHJcblx0XHRcdHJhbmtlcnM6IFNvY2tldFJhbmtlcltdLFxyXG5cdFx0XHRzdGFydFJhbms6IG51bWJlcixcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9sYWRkZXIvdXBkYXRlcyc6IHtcclxuXHRcdGV2ZW50czogU29ja2V0TGFkZGVyRXZlbnRbXSxcclxuXHR9LFxyXG59XHJcblxyXG5jbGFzcyBGYWlyU29ja2V0IHtcclxuXHRzdG9tcENsaWVudDogU3RvbXBKcy5Db21wYXRDbGllbnQ7XHJcblx0dXNlckRhdGEgPSBuZXcgVXNlckRhdGEoKTtcclxuXHRzdGF0ZSA9IFZ1ZS5yZWFjdGl2ZSh7XHJcblx0XHRjb25uZWN0ZWQ6IGZhbHNlLFxyXG5cdFx0Y29ubmVjdGlvblJlcXVlc3RlZDogZmFsc2UsXHJcblx0fSk7XHJcblx0Y29uc3RydWN0b3IoKSB7XHJcblx0XHR0aGlzLnN0b21wQ2xpZW50ID0gU3RvbXBKcy5TdG9tcC5vdmVyKCgpID0+IG5ldyBTb2NrSlMoJ2h0dHBzOi8vZmFpci5rYWxpYnVyZy5kZS9mYWlyc29ja2V0JykpO1xyXG5cdFx0aWYgKCFsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvbXBDbGllbnQuZGVidWcnKSkge1xyXG5cdFx0XHR0aGlzLnN0b21wQ2xpZW50LmRlYnVnID0gKCkgPT4geyB9O1xyXG5cdFx0fVxyXG5cdFx0Zm9yIChsZXQgayBvZiBbXHJcblx0XHRcdCdvbkNoYW5nZVN0YXRlJyxcclxuXHRcdFx0J29uQ29ubmVjdCcsXHJcblx0XHRcdCdvbkRpc2Nvbm5lY3QnLFxyXG5cdFx0XHQnb25TdG9tcEVycm9yJyxcclxuXHRcdFx0J29uVW5oYW5kbGVkRnJhbWUnLFxyXG5cdFx0XHQnb25VbmhhbmRsZWRNZXNzYWdlJyxcclxuXHRcdFx0J29uVW5oYW5kbGVkUmVjZWlwdCcsXHJcblx0XHRcdCdvbldlYlNvY2tldENsb3NlJyxcclxuXHRcdFx0J29uV2ViU29ja2V0RXJyb3InLFxyXG5cdFx0XSBhcyBjb25zdCkge1xyXG5cdFx0XHQvLyBqdXN0IGxvZ2dpbmcgZXZlcnl0aGluZ1xyXG5cdFx0XHR0aGlzLnN0b21wQ2xpZW50W2tdID0gKC4uLmEpID0+IHtcclxuXHRcdFx0XHRpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N0b21wQ2xpZW50LmRlYnVnLmV2ZW50cycpKVxyXG5cdFx0XHRcdFx0Y29uc29sZS53YXJuKGssIC4uLmEpO1xyXG5cdFx0XHRcdCh0aGlzIGFzIGFueSlba10/LiguLi5hKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29uYmVmb3JldW5sb2FkJywgKCkgPT4gdGhpcy5kaXNjb25uZWN0KCkpO1xyXG5cdH1cclxuXHRfcmVzb2x2ZU9uQ29ubmVjdGVkOiAoKCkgPT4gdm9pZClbXSA9IFtdO1xyXG5cdGNvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3Rpb25SZXF1ZXN0ZWQgPSB0cnVlO1xyXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG5cdFx0XHRpZiAodGhpcy5zdG9tcENsaWVudC5jb25uZWN0ZWQpIHtcclxuXHRcdFx0XHRyZXNvbHZlKCk7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0dGhpcy5fcmVzb2x2ZU9uQ29ubmVjdGVkLnB1c2gocmVzb2x2ZSk7XHJcblx0XHRcdFx0dGhpcy5zdG9tcENsaWVudC5jb25uZWN0KHt9LCB0aGlzLnN0b21wQ2xpZW50Lm9uQ29ubmVjdCk7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxuXHRkaXNjb25uZWN0KCkge1xyXG5cdFx0dGhpcy5zdG9tcENsaWVudC5kaXNjb25uZWN0KCk7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3Rpb25SZXF1ZXN0ZWQgPSBmYWxzZTtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGVkID0gZmFsc2U7XHJcblx0fVxyXG5cdG9uQ29ubmVjdCgpIHtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGlvblJlcXVlc3RlZCA9IGZhbHNlO1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0ZWQgPSB0cnVlO1xyXG5cdFx0dGhpcy5fcmVzb2x2ZU9uQ29ubmVjdGVkLm1hcChlID0+IGUoKSk7XHJcblx0fVxyXG5cclxuXHRzZW5kPEsgZXh0ZW5kcyBFeHRyYWN0PGtleW9mIEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGRhdGE6IEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcFtLXSwgbnVtYmVyOiBudW1iZXIpOiB2b2lkO1xyXG5cdHNlbmQ8SyBleHRlbmRzIEV4Y2x1ZGU8a2V5b2YgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwLCBgJHtzdHJpbmd9JCR7c3RyaW5nfWA+PihkZXN0aW5hdGlvbjogSywgZGF0YTogRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwW0tdKTogdm9pZDtcclxuXHRzZW5kPEsgZXh0ZW5kcyBrZXlvZiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXA+KGRlc3RpbmF0aW9uOiBLLCBkYXRhOiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXBbS10sIG51bWJlcj86IG51bWJlcikge1xyXG5cdFx0aWYgKGRlc3RpbmF0aW9uLmluY2x1ZGVzKCckJykpIHtcclxuXHRcdFx0aWYgKG51bWJlciA9PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignYmFkIHVzYWdlJyk7XHJcblx0XHRcdGRlc3RpbmF0aW9uID0gYCR7ZGVzdGluYXRpb24uc3BsaXQoJyQnKVswXX0ke251bWJlcn1gIGFzIGFueTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGlmIChudW1iZXIgIT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0fVxyXG5cdFx0aWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzdG9tcENsaWVudC5kZWJ1Zy5zZW5kJykpXHJcblx0XHRcdGNvbnNvbGUud2FybignU2VuZCcsIGRlc3RpbmF0aW9uLCBkYXRhKTtcclxuXHRcdHRoaXMuc3RvbXBDbGllbnQuc2VuZChkZXN0aW5hdGlvbiwge30sIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuXHR9XHJcblx0c3Vic2NyaWJlPEsgZXh0ZW5kcyBFeHRyYWN0PGtleW9mIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGxpc3RlbmVyOiAoZGF0YTogRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwW0tdKSA9PiB2b2lkLCByZXF1ZXN0OiB7IHV1aWQ6IHV1aWQgfSwgbnVtYmVyOiBudW1iZXIpOiBTdG9tcEpzLlN0b21wU3Vic2NyaXB0aW9uO1xyXG5cdHN1YnNjcmliZTxLIGV4dGVuZHMgRXhjbHVkZTxrZXlvZiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXAsIGAke3N0cmluZ30kJHtzdHJpbmd9YD4+KGRlc3RpbmF0aW9uOiBLLCBsaXN0ZW5lcjogKGRhdGE6IEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcFtLXSkgPT4gdm9pZCwgcmVxdWVzdDogeyB1dWlkOiB1dWlkIH0pOiBTdG9tcEpzLlN0b21wU3Vic2NyaXB0aW9uO1xyXG5cdHN1YnNjcmliZTxLIGV4dGVuZHMga2V5b2YgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwPihkZXN0aW5hdGlvbjogSywgbGlzdGVuZXI6IChkYXRhOiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXBbS10pID0+IHZvaWQsIHJlcXVlc3Q6IHsgdXVpZDogdXVpZCB9LCBudW1iZXI/OiBudW1iZXIpIHtcclxuXHRcdGlmIChkZXN0aW5hdGlvbi5pbmNsdWRlcygnJCcpKSB7XHJcblx0XHRcdGlmIChudW1iZXIgPT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0XHRkZXN0aW5hdGlvbiA9IGAke2Rlc3RpbmF0aW9uLnNwbGl0KCckJylbMF19JHtudW1iZXJ9YCBhcyBhbnk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRpZiAobnVtYmVyICE9IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgdXNhZ2UnKTtcclxuXHRcdH1cclxuXHRcdGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvbXBDbGllbnQuZGVidWcuc3Vic2NyaWJlJykpXHJcblx0XHRcdGNvbnNvbGUud2FybignU3Vic2NyaWJlZCB0bycsIGRlc3RpbmF0aW9uKTtcclxuXHRcdHJldHVybiB0aGlzLnN0b21wQ2xpZW50LnN1YnNjcmliZShkZXN0aW5hdGlvbiwgKG1lc3NhZ2UpID0+IHtcclxuXHRcdFx0bGV0IGRhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2UuYm9keSB8fCAnbnVsbCcpO1xyXG5cdFx0XHRpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N0b21wQ2xpZW50LmRlYnVnLnN1YnNjcmliZS5ldmVudCcpKVxyXG5cdFx0XHRcdGNvbnNvbGUud2FybihkZXN0aW5hdGlvbiwgZGF0YSwgbWVzc2FnZSk7XHJcblx0XHRcdGxpc3RlbmVyKGRhdGEpO1xyXG5cdFx0fSwgcmVxdWVzdCk7XHJcblx0fVxyXG59XHJcbiJdfQ==