"use strict";
class FairSocket {
    stompClient;
    userData = new UserData();
    state = Vue.reactive({
        connected: false,
        connectionRequested: false,
    });
    constructor() {
        this.stompClient = StompJs.Stomp.over(() => new SockJS('https://fair.kaliburg.de/fairsocket'));
        if (!localStorage.getItem('stompClient.debug')) {
            this.stompClient.debug = () => { };
        }
        for (let k of [
            'onChangeState',
            'onConnect',
            'onDisconnect',
            'onStompError',
            'onUnhandledFrame',
            'onUnhandledMessage',
            'onUnhandledReceipt',
            'onWebSocketClose',
            'onWebSocketError',
        ]) {
            // just logging everything
            this.stompClient[k] = (...a) => {
                if (localStorage.getItem('stompClient.debug.events'))
                    console.warn(k, ...a);
                this[k]?.(...a);
            };
        }
        window.addEventListener('onbeforeunload', () => this.disconnect());
    }
    _resolveOnConnected = [];
    connect() {
        this.state.connectionRequested = true;
        return new Promise(resolve => {
            if (this.stompClient.connected) {
                resolve();
            }
            else {
                this._resolveOnConnected.push(resolve);
                this.stompClient.connect({}, this.stompClient.onConnect);
            }
        });
    }
    disconnect() {
        this.stompClient.disconnect();
        this.state.connectionRequested = false;
        this.state.connected = false;
    }
    onConnect() {
        this.state.connectionRequested = false;
        this.state.connected = true;
        this._resolveOnConnected.map(e => e());
    }
    send(destination, data, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        if (localStorage.getItem('stompClient.debug.send'))
            console.warn('Send', destination, data);
        this.stompClient.send(destination, {}, JSON.stringify(data));
    }
    subscribe(destination, listener, request, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        if (localStorage.getItem('stompClient.debug.subscribe'))
            console.warn('Subscribed to', destination);
        return this.stompClient.subscribe(destination, (message) => {
            let data = JSON.parse(message.body || 'null');
            if (localStorage.getItem('stompClient.debug.subscribe.event'))
                console.warn(destination, data, message);
            listener(data);
        }, request);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvbXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQXNJQSxNQUFNLFVBQVU7SUFDZixXQUFXLENBQXVCO0lBQ2xDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFCLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLG1CQUFtQixFQUFFLEtBQUs7S0FDMUIsQ0FBQyxDQUFDO0lBQ0g7UUFDQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLHFDQUFxQyxDQUFDLENBQUMsQ0FBQztRQUMvRixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNuQztRQUNELEtBQUssSUFBSSxDQUFDLElBQUk7WUFDYixlQUFlO1lBQ2YsV0FBVztZQUNYLGNBQWM7WUFDZCxjQUFjO1lBQ2Qsa0JBQWtCO1lBQ2xCLG9CQUFvQjtZQUNwQixvQkFBb0I7WUFDcEIsa0JBQWtCO1lBQ2xCLGtCQUFrQjtTQUNULEVBQUU7WUFDWCwwQkFBMEI7WUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlCLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQztvQkFDbkQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxQixDQUFDLENBQUE7U0FDRDtRQUNELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBQ0QsbUJBQW1CLEdBQW1CLEVBQUUsQ0FBQztJQUN6QyxPQUFPO1FBQ04sSUFBSSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7UUFDdEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QixJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFO2dCQUMvQixPQUFPLEVBQUUsQ0FBQzthQUNWO2lCQUFNO2dCQUNOLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ3pEO1FBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBQ0QsVUFBVTtRQUNULElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUM7UUFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO0lBQzlCLENBQUM7SUFDRCxTQUFTO1FBQ1IsSUFBSSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUM7UUFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQzVCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFJRCxJQUFJLENBQTJDLFdBQWMsRUFBRSxJQUFpQyxFQUFFLE1BQWU7UUFDaEgsSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzlCLElBQUksTUFBTSxJQUFJLFNBQVM7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN0RCxXQUFXLEdBQUcsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sRUFBUyxDQUFDO1NBQzdEO2FBQU07WUFDTixJQUFJLE1BQU0sSUFBSSxTQUFTO2dCQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDdEQ7UUFDRCxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsd0JBQXdCLENBQUM7WUFDakQsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFHRCxTQUFTLENBQWlELFdBQWMsRUFBRSxRQUEyRCxFQUFFLE9BQXVCLEVBQUUsTUFBZTtRQUM5SyxJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxNQUFNLElBQUksU0FBUztnQkFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELFdBQVcsR0FBRyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFTLENBQUM7U0FDN0Q7YUFBTTtZQUNOLElBQUksTUFBTSxJQUFJLFNBQVM7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUN0RDtRQUNELElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQztZQUN0RCxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUM1QyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQzFELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsQ0FBQztZQUM5QyxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsbUNBQW1DLENBQUM7Z0JBQzVELE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMxQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEIsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2IsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbnR5cGUgRGVjaW1hbFN0cmluZyA9IHN0cmluZyAmIHsgXz86ICdEZWNpbWFsU3RyaW5nJyB9O1xyXG5cclxudHlwZSBfQ29uc3RydWN0RXZlbnQ8RXZUeXBlIGV4dGVuZHMgc3RyaW5nLCBEYXRhIGV4dGVuZHMge30+ID1cclxuXHR8IHsgZXZlbnRUeXBlOiBFdlR5cGUgfSAmIERhdGE7XHJcbmludGVyZmFjZSBTb2NrZXRMYWRkZXJFdmVudE1hcCB7XHJcblx0QklBUzoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnQklBUycsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdE1VTFRJOiB7XHJcblx0XHRldmVudFR5cGU6ICdNVUxUSScsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdFZJTkVHQVI6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1ZJTkVHQVInLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0XHRkYXRhOiB7XHJcblx0XHRcdGFtb3VudDogRGVjaW1hbFN0cmluZyxcclxuXHRcdFx0c3VjY2VzczogYm9vbGVhbixcclxuXHRcdH1cclxuXHR9O1xyXG5cdFNPRlRfUkVTRVRfUE9JTlRTOiB7XHJcblx0XHRldmVudFR5cGU6ICdTT0ZUX1JFU0VUX1BPSU5UUycsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdFBST01PVEU6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1BST01PVEUnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRBVVRPX1BST01PVEU6IHtcclxuXHRcdGV2ZW50VHlwZTogJ0FVVE9fUFJPTU9URScsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdEpPSU46IHtcclxuXHRcdGV2ZW50VHlwZTogJ0pPSU4nLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0XHRkYXRhOiB7XHJcblx0XHRcdHVzZXJuYW1lOiBzdHJpbmcsXHJcblx0XHR9XHJcblx0fTtcclxuXHROQU1FX0NIQU5HRToge1xyXG5cdFx0ZXZlbnRUeXBlOiAnTkFNRV9DSEFOR0UnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0XHRkYXRhOiBzdHJpbmcsXHJcblx0fTtcclxuXHRSRVNFVDoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnUkVTRVQnLFxyXG5cdH07XHJcbn1cclxudHlwZSBTb2NrZXRMYWRkZXJFdmVudCA9IFNvY2tldExhZGRlckV2ZW50TWFwW2tleW9mIFNvY2tldExhZGRlckV2ZW50TWFwXTtcclxuaW50ZXJmYWNlIFNvY2tldENoYXRNZXNzYWdlIHtcclxuXHR1c2VybmFtZTogc3RyaW5nO1xyXG5cdGFjY291bnRJZDogYWNjb3VudElkO1xyXG5cdG1lc3NhZ2U6IHN0cmluZztcclxuXHR0aW1lQ3JlYXRlZDogc3RyaW5nO1xyXG5cdHRpbWVzQXNzaG9sZTogbnVtYmVyO1xyXG59XHJcbmludGVyZmFjZSBTb2NrZXRSYW5rZXIge1xyXG5cdGFjY291bnRJZDogYWNjb3VudElkO1xyXG5cdGJpYXM6IG51bWJlcjtcclxuXHRncm93aW5nOiBib29sZWFuO1xyXG5cdG11bHRpcGxpZXI6IG51bWJlcjtcclxuXHRwb2ludHM6IERlY2ltYWxTdHJpbmc7XHJcblx0cG93ZXI6IERlY2ltYWxTdHJpbmc7XHJcblx0cmFuazogbnVtYmVyO1xyXG5cdHRpbWVzQXNzaG9sZTogbnVtYmVyO1xyXG5cdHVzZXJuYW1lOiBzdHJpbmc7XHJcblx0eW91OiBib29sZWFuO1xyXG59XHJcbmludGVyZmFjZSBTb2NrZXRZb3VSYW5rZXIgZXh0ZW5kcyBTb2NrZXRSYW5rZXIge1xyXG5cdGF1dG9Qcm9tb3RlOiBib29sZWFuO1xyXG5cdGdyYXBlczogRGVjaW1hbFN0cmluZztcclxuXHR2aW5lZ2FyOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHlvdTogdHJ1ZTtcclxufVxyXG5cclxuXHJcbmludGVyZmFjZSBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXAge1xyXG5cdCcvYXBwL2FjY291bnQvbG9naW4nOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9hY2NvdW50L25hbWUnOiB7IHV1aWQ6IHV1aWQsIGNvbnRlbnQ6IHN0cmluZyAmIHsgXz86ICduZXdVc2VybmFtZScgfSB9LFxyXG5cdCcvYXBwL2NoYXQvaW5pdC8kbGFkZGVyTnVtJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvY2hhdC9wb3N0LyRjdXJyZW50Q2hhdE51bWJlcic6IHsgdXVpZDogdXVpZCwgY29udGVudDogc3RyaW5nICYgeyBfPzogJ21lc3NhZ2UnIH0gfSxcclxuXHQnL2FwcC9pbmZvJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL2luaXQvJGxhZGRlck51bSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L2Fzc2hvbGUnOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9hdXRvLXByb21vdGUnOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9iaWFzJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvbXVsdGknOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9wcm9tb3RlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvdmluZWdhcic6IHsgdXVpZDogdXVpZCB9LFxyXG59XHJcblxyXG5pbnRlcmZhY2UgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwIHtcclxuXHQnL3RvcGljL2NoYXQvJGxhZGRlck51bSc6IFNvY2tldENoYXRNZXNzYWdlLFxyXG5cdCcvdG9waWMvbGFkZGVyLyRsYWRkZXJOdW0nOiB7IGV2ZW50czogU29ja2V0TGFkZGVyRXZlbnRbXSwgc2Vjb25kc1Bhc3NlZDogbnVtYmVyIH0sXHJcblx0Jy91c2VyL3F1ZXVlL2FjY291bnQvbG9naW4nOiB7XHJcblx0XHRzdGF0dXM6ICdPSycgfCAnQ1JFQVRFRCcgfCAnPycsXHJcblx0XHRjb250ZW50OiB7XHJcblx0XHRcdHV1aWQ6IHV1aWQsIGFjY291bnRJZDogbnVtYmVyLCBoaWdoZXN0Q3VycmVudExhZGRlcjogbnVtYmVyLFxyXG5cdFx0fVxyXG5cdH0sXHJcblx0Jy91c2VyL3F1ZXVlL2NoYXQvJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHRjdXJyZW50Q2hhdE51bWJlcjogbnVtYmVyLFxyXG5cdFx0XHRtZXNzYWdlczogU29ja2V0Q2hhdE1lc3NhZ2VbXSxcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9pbmZvJzoge1xyXG5cdFx0YXNzaG9sZUxhZGRlcjogbnVtYmVyLFxyXG5cdFx0YXNzaG9sZVRhZ3M6IHN0cmluZ1tdLFxyXG5cdFx0YXV0b1Byb21vdGVMYWRkZXI6IG51bWJlcixcclxuXHRcdGJhc2VHcmFwZXNOZWVkZWRUb0F1dG9Qcm9tb3RlOiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0YmFzZVZpbmVnYXJOZWVkZWRUb1Rocm93OiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0bWFudWFsUHJvbW90ZVdhaXRUaW1lOiBudW1iZXIsXHJcblx0XHRtaW5pbXVtUGVvcGxlRm9yUHJvbW90ZTogbnVtYmVyLFxyXG5cdFx0cG9pbnRzRm9yUHJvbW90ZTogRGVjaW1hbFN0cmluZyxcclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9sYWRkZXIvJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHRjdXJyZW50TGFkZGVyOiB7IG51bWJlcjogbnVtYmVyIH0sXHJcblx0XHRcdGZpcnN0UmFua2VyOiBTb2NrZXRSYW5rZXIsXHJcblx0XHRcdHlvdXJSYW5rZXI6IFNvY2tldFlvdVJhbmtlcixcclxuXHRcdFx0cmFua2VyczogU29ja2V0UmFua2VyW10sXHJcblx0XHRcdHN0YXJ0UmFuazogbnVtYmVyLFxyXG5cdFx0fVxyXG5cdH0sXHJcblx0Jy91c2VyL3F1ZXVlL2xhZGRlci91cGRhdGVzJzoge1xyXG5cdFx0ZXZlbnRzOiBTb2NrZXRMYWRkZXJFdmVudFtdLFxyXG5cdH0sXHJcbn1cclxuXHJcbmNsYXNzIEZhaXJTb2NrZXQge1xyXG5cdHN0b21wQ2xpZW50OiBTdG9tcEpzLkNvbXBhdENsaWVudDtcclxuXHR1c2VyRGF0YSA9IG5ldyBVc2VyRGF0YSgpO1xyXG5cdHN0YXRlID0gVnVlLnJlYWN0aXZlKHtcclxuXHRcdGNvbm5lY3RlZDogZmFsc2UsXHJcblx0XHRjb25uZWN0aW9uUmVxdWVzdGVkOiBmYWxzZSxcclxuXHR9KTtcclxuXHRjb25zdHJ1Y3RvcigpIHtcclxuXHRcdHRoaXMuc3RvbXBDbGllbnQgPSBTdG9tcEpzLlN0b21wLm92ZXIoKCkgPT4gbmV3IFNvY2tKUygnaHR0cHM6Ly9mYWlyLmthbGlidXJnLmRlL2ZhaXJzb2NrZXQnKSk7XHJcblx0XHRpZiAoIWxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzdG9tcENsaWVudC5kZWJ1ZycpKSB7XHJcblx0XHRcdHRoaXMuc3RvbXBDbGllbnQuZGVidWcgPSAoKSA9PiB7IH07XHJcblx0XHR9XHJcblx0XHRmb3IgKGxldCBrIG9mIFtcclxuXHRcdFx0J29uQ2hhbmdlU3RhdGUnLFxyXG5cdFx0XHQnb25Db25uZWN0JyxcclxuXHRcdFx0J29uRGlzY29ubmVjdCcsXHJcblx0XHRcdCdvblN0b21wRXJyb3InLFxyXG5cdFx0XHQnb25VbmhhbmRsZWRGcmFtZScsXHJcblx0XHRcdCdvblVuaGFuZGxlZE1lc3NhZ2UnLFxyXG5cdFx0XHQnb25VbmhhbmRsZWRSZWNlaXB0JyxcclxuXHRcdFx0J29uV2ViU29ja2V0Q2xvc2UnLFxyXG5cdFx0XHQnb25XZWJTb2NrZXRFcnJvcicsXHJcblx0XHRdIGFzIGNvbnN0KSB7XHJcblx0XHRcdC8vIGp1c3QgbG9nZ2luZyBldmVyeXRoaW5nXHJcblx0XHRcdHRoaXMuc3RvbXBDbGllbnRba10gPSAoLi4uYSkgPT4ge1xyXG5cdFx0XHRcdGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvbXBDbGllbnQuZGVidWcuZXZlbnRzJykpXHJcblx0XHRcdFx0XHRjb25zb2xlLndhcm4oaywgLi4uYSk7XHJcblx0XHRcdFx0KHRoaXMgYXMgYW55KVtrXT8uKC4uLmEpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb25iZWZvcmV1bmxvYWQnLCAoKSA9PiB0aGlzLmRpc2Nvbm5lY3QoKSk7XHJcblx0fVxyXG5cdF9yZXNvbHZlT25Db25uZWN0ZWQ6ICgoKSA9PiB2b2lkKVtdID0gW107XHJcblx0Y29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGlvblJlcXVlc3RlZCA9IHRydWU7XHJcblx0XHRyZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XHJcblx0XHRcdGlmICh0aGlzLnN0b21wQ2xpZW50LmNvbm5lY3RlZCkge1xyXG5cdFx0XHRcdHJlc29sdmUoKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHR0aGlzLl9yZXNvbHZlT25Db25uZWN0ZWQucHVzaChyZXNvbHZlKTtcclxuXHRcdFx0XHR0aGlzLnN0b21wQ2xpZW50LmNvbm5lY3Qoe30sIHRoaXMuc3RvbXBDbGllbnQub25Db25uZWN0KTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cdGRpc2Nvbm5lY3QoKSB7XHJcblx0XHR0aGlzLnN0b21wQ2xpZW50LmRpc2Nvbm5lY3QoKTtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGlvblJlcXVlc3RlZCA9IGZhbHNlO1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0ZWQgPSBmYWxzZTtcclxuXHR9XHJcblx0b25Db25uZWN0KCkge1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0aW9uUmVxdWVzdGVkID0gZmFsc2U7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3RlZCA9IHRydWU7XHJcblx0XHR0aGlzLl9yZXNvbHZlT25Db25uZWN0ZWQubWFwKGUgPT4gZSgpKTtcclxuXHR9XHJcblxyXG5cdHNlbmQ8SyBleHRlbmRzIEV4dHJhY3Q8a2V5b2YgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwLCBgJHtzdHJpbmd9JCR7c3RyaW5nfWA+PihkZXN0aW5hdGlvbjogSywgZGF0YTogRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwW0tdLCBudW1iZXI6IG51bWJlcik6IHZvaWQ7XHJcblx0c2VuZDxLIGV4dGVuZHMgRXhjbHVkZTxrZXlvZiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXAsIGAke3N0cmluZ30kJHtzdHJpbmd9YD4+KGRlc3RpbmF0aW9uOiBLLCBkYXRhOiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXBbS10pOiB2b2lkO1xyXG5cdHNlbmQ8SyBleHRlbmRzIGtleW9mIEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcD4oZGVzdGluYXRpb246IEssIGRhdGE6IEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcFtLXSwgbnVtYmVyPzogbnVtYmVyKSB7XHJcblx0XHRpZiAoZGVzdGluYXRpb24uaW5jbHVkZXMoJyQnKSkge1xyXG5cdFx0XHRpZiAobnVtYmVyID09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgdXNhZ2UnKTtcclxuXHRcdFx0ZGVzdGluYXRpb24gPSBgJHtkZXN0aW5hdGlvbi5zcGxpdCgnJCcpWzBdfSR7bnVtYmVyfWAgYXMgYW55O1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0aWYgKG51bWJlciAhPSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignYmFkIHVzYWdlJyk7XHJcblx0XHR9XHJcblx0XHRpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N0b21wQ2xpZW50LmRlYnVnLnNlbmQnKSlcclxuXHRcdFx0Y29uc29sZS53YXJuKCdTZW5kJywgZGVzdGluYXRpb24sIGRhdGEpO1xyXG5cdFx0dGhpcy5zdG9tcENsaWVudC5zZW5kKGRlc3RpbmF0aW9uLCB7fSwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG5cdH1cclxuXHRzdWJzY3JpYmU8SyBleHRlbmRzIEV4dHJhY3Q8a2V5b2YgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwLCBgJHtzdHJpbmd9JCR7c3RyaW5nfWA+PihkZXN0aW5hdGlvbjogSywgbGlzdGVuZXI6IChkYXRhOiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXBbS10pID0+IHZvaWQsIHJlcXVlc3Q6IHsgdXVpZDogdXVpZCB9LCBudW1iZXI6IG51bWJlcik6IFN0b21wSnMuU3RvbXBTdWJzY3JpcHRpb247XHJcblx0c3Vic2NyaWJlPEsgZXh0ZW5kcyBFeGNsdWRlPGtleW9mIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGxpc3RlbmVyOiAoZGF0YTogRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwW0tdKSA9PiB2b2lkLCByZXF1ZXN0OiB7IHV1aWQ6IHV1aWQgfSk6IFN0b21wSnMuU3RvbXBTdWJzY3JpcHRpb247XHJcblx0c3Vic2NyaWJlPEsgZXh0ZW5kcyBrZXlvZiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXA+KGRlc3RpbmF0aW9uOiBLLCBsaXN0ZW5lcjogKGRhdGE6IEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcFtLXSkgPT4gdm9pZCwgcmVxdWVzdDogeyB1dWlkOiB1dWlkIH0sIG51bWJlcj86IG51bWJlcikge1xyXG5cdFx0aWYgKGRlc3RpbmF0aW9uLmluY2x1ZGVzKCckJykpIHtcclxuXHRcdFx0aWYgKG51bWJlciA9PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignYmFkIHVzYWdlJyk7XHJcblx0XHRcdGRlc3RpbmF0aW9uID0gYCR7ZGVzdGluYXRpb24uc3BsaXQoJyQnKVswXX0ke251bWJlcn1gIGFzIGFueTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGlmIChudW1iZXIgIT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0fVxyXG5cdFx0aWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzdG9tcENsaWVudC5kZWJ1Zy5zdWJzY3JpYmUnKSlcclxuXHRcdFx0Y29uc29sZS53YXJuKCdTdWJzY3JpYmVkIHRvJywgZGVzdGluYXRpb24pO1xyXG5cdFx0cmV0dXJuIHRoaXMuc3RvbXBDbGllbnQuc3Vic2NyaWJlKGRlc3RpbmF0aW9uLCAobWVzc2FnZSkgPT4ge1xyXG5cdFx0XHRsZXQgZGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZS5ib2R5IHx8ICdudWxsJyk7XHJcblx0XHRcdGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvbXBDbGllbnQuZGVidWcuc3Vic2NyaWJlLmV2ZW50JykpXHJcblx0XHRcdFx0Y29uc29sZS53YXJuKGRlc3RpbmF0aW9uLCBkYXRhLCBtZXNzYWdlKTtcclxuXHRcdFx0bGlzdGVuZXIoZGF0YSk7XHJcblx0XHR9LCByZXF1ZXN0KTtcclxuXHR9XHJcbn1cclxuIl19