"use strict";
class FairSocket {
    stompClient;
    userData = new UserData();
    state = Vue.reactive({
        connected: false,
        connectionRequested: false,
    });
    constructor() {
        this.stompClient = StompJs.Stomp.over(() => new SockJS('https://fair.kaliburg.de/fairsocket'));
        for (let k of [
            'onChangeState',
            'onConnect',
            'onDisconnect',
            'onStompError',
            'onUnhandledFrame',
            'onUnhandledMessage',
            'onUnhandledReceipt',
            'onWebSocketClose',
            'onWebSocketError',
        ]) {
            // just logging everything
            this.stompClient[k] = (...a) => {
                console.warn(k, ...a);
                this[k]?.(...a);
            };
        }
        window.addEventListener('onbeforeunload', () => this.disconnect());
    }
    _resolveOnConnected = [];
    connect() {
        this.state.connectionRequested = true;
        return new Promise(resolve => {
            if (this.stompClient.connected) {
                resolve();
            }
            else {
                this._resolveOnConnected.push(resolve);
                this.stompClient.connect({}, this.stompClient.onConnect);
            }
        });
    }
    disconnect() {
        this.stompClient.disconnect();
        this.state.connectionRequested = false;
        this.state.connected = false;
    }
    onConnect() {
        this.state.connectionRequested = false;
        this.state.connected = true;
        this._resolveOnConnected.map(e => e());
    }
    send(destination, data, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        this.stompClient.send(destination, {}, JSON.stringify(data));
    }
    subscribe(destination, listener, request, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        return this.stompClient.subscribe(destination, (message) => {
            let data = JSON.parse(message.body || 'null');
            console.warn(destination, data, message);
            listener(data);
        }, request);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvbXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQXNJQSxNQUFNLFVBQVU7SUFDZixXQUFXLENBQXVCO0lBQ2xDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFCLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLG1CQUFtQixFQUFFLEtBQUs7S0FDMUIsQ0FBQyxDQUFDO0lBQ0g7UUFDQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLHFDQUFxQyxDQUFDLENBQUMsQ0FBQztRQUMvRixLQUFLLElBQUksQ0FBQyxJQUFJO1lBQ2IsZUFBZTtZQUNmLFdBQVc7WUFDWCxjQUFjO1lBQ2QsY0FBYztZQUNkLGtCQUFrQjtZQUNsQixvQkFBb0I7WUFDcEIsb0JBQW9CO1lBQ3BCLGtCQUFrQjtZQUNsQixrQkFBa0I7U0FDVCxFQUFFO1lBQ1gsMEJBQTBCO1lBQzFCLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFO2dCQUM5QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixJQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFCLENBQUMsQ0FBQTtTQUNEO1FBQ0QsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFDRCxtQkFBbUIsR0FBbUIsRUFBRSxDQUFDO0lBQ3pDLE9BQU87UUFDTixJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQztRQUN0QyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzVCLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUU7Z0JBQy9CLE9BQU8sRUFBRSxDQUFDO2FBQ1Y7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDdkMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDekQ7UUFDRixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFDRCxVQUFVO1FBQ1QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQixHQUFHLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUNELFNBQVM7UUFDUixJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQixHQUFHLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDNUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUlELElBQUksQ0FBMkMsV0FBYyxFQUFFLElBQWlDLEVBQUUsTUFBZTtRQUNoSCxJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxNQUFNLElBQUksU0FBUztnQkFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELFdBQVcsR0FBRyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFTLENBQUM7U0FDN0Q7YUFBTTtZQUNOLElBQUksTUFBTSxJQUFJLFNBQVM7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUN0RDtRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFHRCxTQUFTLENBQWlELFdBQWMsRUFBRSxRQUEyRCxFQUFFLE9BQXVCLEVBQUUsTUFBZTtRQUM5SyxJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxNQUFNLElBQUksU0FBUztnQkFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELFdBQVcsR0FBRyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFTLENBQUM7U0FDN0Q7YUFBTTtZQUNOLElBQUksTUFBTSxJQUFJLFNBQVM7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUN0RDtRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDMUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxDQUFDO1lBQzlDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN6QyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEIsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2IsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbnR5cGUgRGVjaW1hbFN0cmluZyA9IHN0cmluZyAmIHsgXz86ICdEZWNpbWFsU3RyaW5nJyB9O1xyXG5cclxudHlwZSBfQ29uc3RydWN0RXZlbnQ8RXZUeXBlIGV4dGVuZHMgc3RyaW5nLCBEYXRhIGV4dGVuZHMge30+ID0gXHJcblx0fCB7ZXZlbnRUeXBlOiBFdlR5cGV9ICYgRGF0YTtcclxuaW50ZXJmYWNlIFNvY2tldExhZGRlckV2ZW50TWFwIHtcclxuXHRCSUFTOiB7XHJcblx0XHRldmVudFR5cGU6ICdCSUFTJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdH07XHJcblx0TVVMVEk6IHtcclxuXHRcdGV2ZW50VHlwZTogJ01VTFRJJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdH07XHJcblx0VklORUdBUjoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnVklORUdBUicsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHRcdGRhdGE6IHtcclxuXHRcdFx0YW1vdW50OiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0XHRzdWNjZXNzOiBib29sZWFuLFxyXG5cdFx0fVxyXG5cdH07XHJcblx0U09GVF9SRVNFVF9QT0lOVFM6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1NPRlRfUkVTRVRfUE9JTlRTJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdH07XHJcblx0UFJPTU9URToge1xyXG5cdFx0ZXZlbnRUeXBlOiAnUFJPTU9URScsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHR9O1xyXG5cdEFVVE9fUFJPTU9URToge1xyXG5cdFx0ZXZlbnRUeXBlOiAnQVVUT19QUk9NT1RFJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdH07XHJcblx0Sk9JTjoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnSk9JTicsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHRcdGRhdGE6IHtcclxuXHRcdFx0dXNlcm5hbWU6IHN0cmluZyxcclxuXHRcdH1cclxuXHR9O1xyXG5cdE5BTUVfQ0hBTkdFOiB7XHJcblx0XHRldmVudFR5cGU6ICdOQU1FX0NIQU5HRScsXHJcblx0XHRhY2NvdW50SWQ6IGFjY291bnRJZCxcclxuXHRcdGRhdGE6IHN0cmluZyxcclxuXHR9O1xyXG5cdFJFU0VUOiB7XHJcblx0XHRldmVudFR5cGU6ICdSRVNFVCcsXHJcblx0fTtcclxufVxyXG50eXBlIFNvY2tldExhZGRlckV2ZW50ID0gU29ja2V0TGFkZGVyRXZlbnRNYXBba2V5b2YgU29ja2V0TGFkZGVyRXZlbnRNYXBdOyBcclxuaW50ZXJmYWNlIFNvY2tldENoYXRNZXNzYWdlIHtcclxuXHR1c2VybmFtZTogc3RyaW5nO1xyXG5cdGFjY291bnRJZDogYWNjb3VudElkO1xyXG5cdG1lc3NhZ2U6IHN0cmluZztcclxuXHR0aW1lQ3JlYXRlZDogc3RyaW5nO1xyXG5cdHRpbWVzQXNzaG9sZTogbnVtYmVyO1xyXG59XHJcbmludGVyZmFjZSBTb2NrZXRSYW5rZXIge1xyXG5cdGFjY291bnRJZDogYWNjb3VudElkO1xyXG5cdGJpYXM6IG51bWJlcjtcclxuXHRncm93aW5nOiBib29sZWFuO1xyXG5cdG11bHRpcGxpZXI6IG51bWJlcjtcclxuXHRwb2ludHM6IERlY2ltYWxTdHJpbmc7XHJcblx0cG93ZXI6IERlY2ltYWxTdHJpbmc7XHJcblx0cmFuazogbnVtYmVyO1xyXG5cdHRpbWVzQXNzaG9sZTogbnVtYmVyO1xyXG5cdHVzZXJuYW1lOiBzdHJpbmc7XHJcblx0eW91OiBib29sZWFuO1xyXG59XHJcbmludGVyZmFjZSBTb2NrZXRZb3VSYW5rZXIgZXh0ZW5kcyBTb2NrZXRSYW5rZXIge1xyXG5cdGF1dG9Qcm9tb3RlOiBib29sZWFuO1xyXG5cdGdyYXBlczogRGVjaW1hbFN0cmluZztcclxuXHR2aW5lZ2FyOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHlvdTogdHJ1ZTtcclxufVxyXG5cclxuXHJcbmludGVyZmFjZSBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXAge1xyXG5cdCcvYXBwL2FjY291bnQvbG9naW4nOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9hY2NvdW50L25hbWUnOiB7IHV1aWQ6IHV1aWQsIGNvbnRlbnQ6IHN0cmluZyAmIHsgXz86ICduZXdVc2VybmFtZScgfSB9LFxyXG5cdCcvYXBwL2NoYXQvaW5pdC8kbGFkZGVyTnVtJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvY2hhdC9wb3N0LyRjdXJyZW50Q2hhdE51bWJlcic6IHsgdXVpZDogdXVpZCwgY29udGVudDogc3RyaW5nICYgeyBfPzogJ21lc3NhZ2UnIH0gfSxcclxuXHQnL2FwcC9pbmZvJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL2luaXQvJGxhZGRlck51bSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L2Fzc2hvbGUnOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9hdXRvLXByb21vdGUnOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9iaWFzJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvbXVsdGknOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9wcm9tb3RlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvdmluZWdhcic6IHsgdXVpZDogdXVpZCB9LFxyXG59XHJcblxyXG5pbnRlcmZhY2UgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwIHtcclxuXHQnL3RvcGljL2NoYXQvJGxhZGRlck51bSc6IFNvY2tldENoYXRNZXNzYWdlLFxyXG5cdCcvdG9waWMvbGFkZGVyLyRsYWRkZXJOdW0nOiB7IGV2ZW50czogU29ja2V0TGFkZGVyRXZlbnRbXSwgc2Vjb25kc1Bhc3NlZDogbnVtYmVyIH0sXHJcblx0Jy91c2VyL3F1ZXVlL2FjY291bnQvbG9naW4nOiB7XHJcblx0XHRzdGF0dXM6ICdPSycgfCAnQ1JFQVRFRCcgfCAnPycsXHJcblx0XHRjb250ZW50OiB7XHJcblx0XHRcdHV1aWQ6IHV1aWQsIGFjY291bnRJZDogbnVtYmVyLCBoaWdoZXN0Q3VycmVudExhZGRlcjogbnVtYmVyLFxyXG5cdFx0fVxyXG5cdH0sXHJcblx0Jy91c2VyL3F1ZXVlL2NoYXQvJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHRjdXJyZW50Q2hhdE51bWJlcjogbnVtYmVyLFxyXG5cdFx0XHRtZXNzYWdlczogU29ja2V0Q2hhdE1lc3NhZ2VbXSxcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9pbmZvJzoge1xyXG5cdFx0YXNzaG9sZUxhZGRlcjogbnVtYmVyLFxyXG5cdFx0YXNzaG9sZVRhZ3M6IHN0cmluZ1tdLFxyXG5cdFx0YXV0b1Byb21vdGVMYWRkZXI6IG51bWJlcixcclxuXHRcdGJhc2VHcmFwZXNOZWVkZWRUb0F1dG9Qcm9tb3RlOiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0YmFzZVZpbmVnYXJOZWVkZWRUb1Rocm93OiBEZWNpbWFsU3RyaW5nLFxyXG5cdFx0bWFudWFsUHJvbW90ZVdhaXRUaW1lOiBudW1iZXIsXHJcblx0XHRtaW5pbXVtUGVvcGxlRm9yUHJvbW90ZTogbnVtYmVyLFxyXG5cdFx0cG9pbnRzRm9yUHJvbW90ZTogRGVjaW1hbFN0cmluZyxcclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9sYWRkZXIvJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHRjdXJyZW50TGFkZGVyOiB7IG51bWJlcjogbnVtYmVyIH0sXHJcblx0XHRcdGZpcnN0UmFua2VyOiBTb2NrZXRSYW5rZXIsXHJcblx0XHRcdHlvdXJSYW5rZXI6IFNvY2tldFlvdVJhbmtlcixcclxuXHRcdFx0cmFua2VyczogU29ja2V0UmFua2VyW10sXHJcblx0XHRcdHN0YXJ0UmFuazogbnVtYmVyLFxyXG5cdFx0fVxyXG5cdH0sXHJcblx0Jy91c2VyL3F1ZXVlL2xhZGRlci91cGRhdGVzJzoge1xyXG5cdFx0ZXZlbnRzOiBTb2NrZXRMYWRkZXJFdmVudFtdLFxyXG5cdH0sXHJcbn1cclxuXHJcbmNsYXNzIEZhaXJTb2NrZXQge1xyXG5cdHN0b21wQ2xpZW50OiBTdG9tcEpzLkNvbXBhdENsaWVudDtcclxuXHR1c2VyRGF0YSA9IG5ldyBVc2VyRGF0YSgpO1xyXG5cdHN0YXRlID0gVnVlLnJlYWN0aXZlKHtcclxuXHRcdGNvbm5lY3RlZDogZmFsc2UsXHJcblx0XHRjb25uZWN0aW9uUmVxdWVzdGVkOiBmYWxzZSxcclxuXHR9KTtcclxuXHRjb25zdHJ1Y3RvcigpIHtcclxuXHRcdHRoaXMuc3RvbXBDbGllbnQgPSBTdG9tcEpzLlN0b21wLm92ZXIoKCkgPT4gbmV3IFNvY2tKUygnaHR0cHM6Ly9mYWlyLmthbGlidXJnLmRlL2ZhaXJzb2NrZXQnKSk7XHJcblx0XHRmb3IgKGxldCBrIG9mIFtcclxuXHRcdFx0J29uQ2hhbmdlU3RhdGUnLFxyXG5cdFx0XHQnb25Db25uZWN0JyxcclxuXHRcdFx0J29uRGlzY29ubmVjdCcsXHJcblx0XHRcdCdvblN0b21wRXJyb3InLFxyXG5cdFx0XHQnb25VbmhhbmRsZWRGcmFtZScsXHJcblx0XHRcdCdvblVuaGFuZGxlZE1lc3NhZ2UnLFxyXG5cdFx0XHQnb25VbmhhbmRsZWRSZWNlaXB0JyxcclxuXHRcdFx0J29uV2ViU29ja2V0Q2xvc2UnLFxyXG5cdFx0XHQnb25XZWJTb2NrZXRFcnJvcicsXHJcblx0XHRdIGFzIGNvbnN0KSB7XHJcblx0XHRcdC8vIGp1c3QgbG9nZ2luZyBldmVyeXRoaW5nXHJcblx0XHRcdHRoaXMuc3RvbXBDbGllbnRba10gPSAoLi4uYSkgPT4ge1xyXG5cdFx0XHRcdGNvbnNvbGUud2FybihrLCAuLi5hKTtcclxuXHRcdFx0XHQodGhpcyBhcyBhbnkpW2tdPy4oLi4uYSk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHRcdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmJlZm9yZXVubG9hZCcsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcclxuXHR9XHJcblx0X3Jlc29sdmVPbkNvbm5lY3RlZDogKCgpID0+IHZvaWQpW10gPSBbXTtcclxuXHRjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0aW9uUmVxdWVzdGVkID0gdHJ1ZTtcclxuXHRcdHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuXHRcdFx0aWYgKHRoaXMuc3RvbXBDbGllbnQuY29ubmVjdGVkKSB7XHJcblx0XHRcdFx0cmVzb2x2ZSgpO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHRoaXMuX3Jlc29sdmVPbkNvbm5lY3RlZC5wdXNoKHJlc29sdmUpO1xyXG5cdFx0XHRcdHRoaXMuc3RvbXBDbGllbnQuY29ubmVjdCh7fSwgdGhpcy5zdG9tcENsaWVudC5vbkNvbm5lY3QpO1xyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHR9XHJcblx0ZGlzY29ubmVjdCgpIHtcclxuXHRcdHRoaXMuc3RvbXBDbGllbnQuZGlzY29ubmVjdCgpO1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0aW9uUmVxdWVzdGVkID0gZmFsc2U7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3RlZCA9IGZhbHNlO1xyXG5cdH1cclxuXHRvbkNvbm5lY3QoKSB7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3Rpb25SZXF1ZXN0ZWQgPSBmYWxzZTtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGVkID0gdHJ1ZTtcclxuXHRcdHRoaXMuX3Jlc29sdmVPbkNvbm5lY3RlZC5tYXAoZSA9PiBlKCkpO1xyXG5cdH1cclxuXHJcblx0c2VuZDxLIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXAsIGAke3N0cmluZ30kJHtzdHJpbmd9YD4+KGRlc3RpbmF0aW9uOiBLLCBkYXRhOiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXBbS10sIG51bWJlcjogbnVtYmVyKTogdm9pZDtcclxuXHRzZW5kPEsgZXh0ZW5kcyBFeGNsdWRlPGtleW9mIEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGRhdGE6IEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcFtLXSk6IHZvaWQ7XHJcblx0c2VuZDxLIGV4dGVuZHMga2V5b2YgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwPihkZXN0aW5hdGlvbjogSywgZGF0YTogRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwW0tdLCBudW1iZXI/OiBudW1iZXIpIHtcclxuXHRcdGlmIChkZXN0aW5hdGlvbi5pbmNsdWRlcygnJCcpKSB7XHJcblx0XHRcdGlmIChudW1iZXIgPT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0XHRkZXN0aW5hdGlvbiA9IGAke2Rlc3RpbmF0aW9uLnNwbGl0KCckJylbMF19JHtudW1iZXJ9YCBhcyBhbnk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRpZiAobnVtYmVyICE9IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgdXNhZ2UnKTtcclxuXHRcdH1cclxuXHRcdHRoaXMuc3RvbXBDbGllbnQuc2VuZChkZXN0aW5hdGlvbiwge30sIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuXHR9XHJcblx0c3Vic2NyaWJlPEsgZXh0ZW5kcyBFeHRyYWN0PGtleW9mIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGxpc3RlbmVyOiAoZGF0YTogRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwW0tdKSA9PiB2b2lkLCByZXF1ZXN0OiB7IHV1aWQ6IHV1aWQgfSwgbnVtYmVyOiBudW1iZXIpOiBTdG9tcEpzLlN0b21wU3Vic2NyaXB0aW9uO1xyXG5cdHN1YnNjcmliZTxLIGV4dGVuZHMgRXhjbHVkZTxrZXlvZiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXAsIGAke3N0cmluZ30kJHtzdHJpbmd9YD4+KGRlc3RpbmF0aW9uOiBLLCBsaXN0ZW5lcjogKGRhdGE6IEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcFtLXSkgPT4gdm9pZCwgcmVxdWVzdDogeyB1dWlkOiB1dWlkIH0pOiBTdG9tcEpzLlN0b21wU3Vic2NyaXB0aW9uO1xyXG5cdHN1YnNjcmliZTxLIGV4dGVuZHMga2V5b2YgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwPihkZXN0aW5hdGlvbjogSywgbGlzdGVuZXI6IChkYXRhOiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXBbS10pID0+IHZvaWQsIHJlcXVlc3Q6IHsgdXVpZDogdXVpZCB9LCBudW1iZXI/OiBudW1iZXIpIHtcclxuXHRcdGlmIChkZXN0aW5hdGlvbi5pbmNsdWRlcygnJCcpKSB7XHJcblx0XHRcdGlmIChudW1iZXIgPT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0XHRkZXN0aW5hdGlvbiA9IGAke2Rlc3RpbmF0aW9uLnNwbGl0KCckJylbMF19JHtudW1iZXJ9YCBhcyBhbnk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRpZiAobnVtYmVyICE9IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdiYWQgdXNhZ2UnKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0aGlzLnN0b21wQ2xpZW50LnN1YnNjcmliZShkZXN0aW5hdGlvbiwgKG1lc3NhZ2UpID0+IHtcclxuXHRcdFx0bGV0IGRhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2UuYm9keSB8fCAnbnVsbCcpO1xyXG5cdFx0XHRjb25zb2xlLndhcm4oZGVzdGluYXRpb24sIGRhdGEsIG1lc3NhZ2UpO1xyXG5cdFx0XHRsaXN0ZW5lcihkYXRhKTtcclxuXHRcdH0sIHJlcXVlc3QpO1xyXG5cdH1cclxufVxyXG4iXX0=