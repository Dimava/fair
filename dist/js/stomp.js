"use strict";
class FairSocket {
    stompClient;
    userData = new UserData();
    state = Vue.reactive({
        connected: false,
        connectionRequested: false,
    });
    constructor() {
        this.stompClient = StompJs.Stomp.over(() => new SockJS('https://fair.kaliburg.de/fairsocket'));
        if (!localStorage.getItem('stompClient.debug')) {
            this.stompClient.debug = () => { };
        }
        for (let k of [
            'onChangeState',
            'onConnect',
            'onDisconnect',
            'onStompError',
            'onUnhandledFrame',
            'onUnhandledMessage',
            'onUnhandledReceipt',
            'onWebSocketClose',
            'onWebSocketError',
        ]) {
            // just logging everything
            this.stompClient[k] = (...a) => {
                if (localStorage.getItem('stompClient.logEvents'))
                    console.warn(k, ...a);
                this[k]?.(...a);
            };
        }
        window.addEventListener('onbeforeunload', () => this.disconnect());
    }
    _resolveOnConnected = [];
    connect() {
        this.state.connectionRequested = true;
        return new Promise(resolve => {
            if (this.stompClient.connected) {
                resolve();
            }
            else {
                this._resolveOnConnected.push(resolve);
                this.stompClient.connect({}, this.stompClient.onConnect);
            }
        });
    }
    disconnect() {
        this.stompClient.disconnect();
        this.state.connectionRequested = false;
        this.state.connected = false;
    }
    onConnect() {
        this.state.connectionRequested = false;
        this.state.connected = true;
        this._resolveOnConnected.map(e => e());
    }
    send(destination, data, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        this.stompClient.send(destination, {}, JSON.stringify(data));
    }
    subscribe(destination, listener, request, number) {
        if (destination.includes('$')) {
            if (number == undefined)
                throw new Error('bad usage');
            destination = `${destination.split('$')[0]}${number}`;
        }
        else {
            if (number != undefined)
                throw new Error('bad usage');
        }
        return this.stompClient.subscribe(destination, (message) => {
            let data = JSON.parse(message.body || 'null');
            console.warn(destination, data, message);
            listener(data);
        }, request);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvbXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvbXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQXNJQSxNQUFNLFVBQVU7SUFDZixXQUFXLENBQXVCO0lBQ2xDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFCLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLG1CQUFtQixFQUFFLEtBQUs7S0FDMUIsQ0FBQyxDQUFDO0lBQ0g7UUFDQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLHFDQUFxQyxDQUFDLENBQUMsQ0FBQztRQUMvRixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNuQztRQUNELEtBQUssSUFBSSxDQUFDLElBQUk7WUFDYixlQUFlO1lBQ2YsV0FBVztZQUNYLGNBQWM7WUFDZCxjQUFjO1lBQ2Qsa0JBQWtCO1lBQ2xCLG9CQUFvQjtZQUNwQixvQkFBb0I7WUFDcEIsa0JBQWtCO1lBQ2xCLGtCQUFrQjtTQUNULEVBQUU7WUFDWCwwQkFBMEI7WUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlCLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztvQkFDaEQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxQixDQUFDLENBQUE7U0FDRDtRQUNE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QUksQ0FBQyxDQUFDO1FBQ2hCLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbIlxyXG50eXBlIERlY2ltYWxTdHJpbmcgPSBzdHJpbmcgJiB7IF8/OiAnRGVjaW1hbFN0cmluZycgfTtcclxuXHJcbnR5cGUgX0NvbnN0cnVjdEV2ZW50PEV2VHlwZSBleHRlbmRzIHN0cmluZywgRGF0YSBleHRlbmRzIHt9PiA9XHJcblx0fCB7IGV2ZW50VHlwZTogRXZUeXBlIH0gJiBEYXRhO1xyXG5pbnRlcmZhY2UgU29ja2V0TGFkZGVyRXZlbnRNYXAge1xyXG5cdEJJQVM6IHtcclxuXHRcdGV2ZW50VHlwZTogJ0JJQVMnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRNVUxUSToge1xyXG5cdFx0ZXZlbnRUeXBlOiAnTVVMVEknLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRWSU5FR0FSOiB7XHJcblx0XHRldmVudFR5cGU6ICdWSU5FR0FSJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdFx0ZGF0YToge1xyXG5cdFx0XHRhbW91bnQ6IERlY2ltYWxTdHJpbmcsXHJcblx0XHRcdHN1Y2Nlc3M6IGJvb2xlYW4sXHJcblx0XHR9XHJcblx0fTtcclxuXHRTT0ZUX1JFU0VUX1BPSU5UUzoge1xyXG5cdFx0ZXZlbnRUeXBlOiAnU09GVF9SRVNFVF9QT0lOVFMnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRQUk9NT1RFOiB7XHJcblx0XHRldmVudFR5cGU6ICdQUk9NT1RFJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdH07XHJcblx0QVVUT19QUk9NT1RFOiB7XHJcblx0XHRldmVudFR5cGU6ICdBVVRPX1BST01PVEUnLFxyXG5cdFx0YWNjb3VudElkOiBhY2NvdW50SWQsXHJcblx0fTtcclxuXHRKT0lOOiB7XHJcblx0XHRldmVudFR5cGU6ICdKT0lOJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdFx0ZGF0YToge1xyXG5cdFx0XHR1c2VybmFtZTogc3RyaW5nLFxyXG5cdFx0fVxyXG5cdH07XHJcblx0TkFNRV9DSEFOR0U6IHtcclxuXHRcdGV2ZW50VHlwZTogJ05BTUVfQ0hBTkdFJyxcclxuXHRcdGFjY291bnRJZDogYWNjb3VudElkLFxyXG5cdFx0ZGF0YTogc3RyaW5nLFxyXG5cdH07XHJcblx0UkVTRVQ6IHtcclxuXHRcdGV2ZW50VHlwZTogJ1JFU0VUJyxcclxuXHR9O1xyXG59XHJcbnR5cGUgU29ja2V0TGFkZGVyRXZlbnQgPSBTb2NrZXRMYWRkZXJFdmVudE1hcFtrZXlvZiBTb2NrZXRMYWRkZXJFdmVudE1hcF07XHJcbmludGVyZmFjZSBTb2NrZXRDaGF0TWVzc2FnZSB7XHJcblx0dXNlcm5hbWU6IHN0cmluZztcclxuXHRhY2NvdW50SWQ6IGFjY291bnRJZDtcclxuXHRtZXNzYWdlOiBzdHJpbmc7XHJcblx0dGltZUNyZWF0ZWQ6IHN0cmluZztcclxuXHR0aW1lc0Fzc2hvbGU6IG51bWJlcjtcclxufVxyXG5pbnRlcmZhY2UgU29ja2V0UmFua2VyIHtcclxuXHRhY2NvdW50SWQ6IGFjY291bnRJZDtcclxuXHRiaWFzOiBudW1iZXI7XHJcblx0Z3Jvd2luZzogYm9vbGVhbjtcclxuXHRtdWx0aXBsaWVyOiBudW1iZXI7XHJcblx0cG9pbnRzOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHBvd2VyOiBEZWNpbWFsU3RyaW5nO1xyXG5cdHJhbms6IG51bWJlcjtcclxuXHR0aW1lc0Fzc2hvbGU6IG51bWJlcjtcclxuXHR1c2VybmFtZTogc3RyaW5nO1xyXG5cdHlvdTogYm9vbGVhbjtcclxufVxyXG5pbnRlcmZhY2UgU29ja2V0WW91UmFua2VyIGV4dGVuZHMgU29ja2V0UmFua2VyIHtcclxuXHRhdXRvUHJvbW90ZTogYm9vbGVhbjtcclxuXHRncmFwZXM6IERlY2ltYWxTdHJpbmc7XHJcblx0dmluZWdhcjogRGVjaW1hbFN0cmluZztcclxuXHR5b3U6IHRydWU7XHJcbn1cclxuXHJcblxyXG5pbnRlcmZhY2UgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwIHtcclxuXHQnL2FwcC9hY2NvdW50L2xvZ2luJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvYWNjb3VudC9uYW1lJzogeyB1dWlkOiB1dWlkLCBjb250ZW50OiBzdHJpbmcgJiB7IF8/OiAnbmV3VXNlcm5hbWUnIH0gfSxcclxuXHQnL2FwcC9jaGF0L2luaXQvJGxhZGRlck51bSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2NoYXQvcG9zdC8kY3VycmVudENoYXROdW1iZXInOiB7IHV1aWQ6IHV1aWQsIGNvbnRlbnQ6IHN0cmluZyAmIHsgXz86ICdtZXNzYWdlJyB9IH0sXHJcblx0Jy9hcHAvaW5mbyc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9pbml0LyRsYWRkZXJOdW0nOiB7IHV1aWQ6IHV1aWQgfSxcclxuXHQnL2FwcC9sYWRkZXIvcG9zdC9hc3Nob2xlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvYXV0by1wcm9tb3RlJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvYmlhcyc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L211bHRpJzogeyB1dWlkOiB1dWlkIH0sXHJcblx0Jy9hcHAvbGFkZGVyL3Bvc3QvcHJvbW90ZSc6IHsgdXVpZDogdXVpZCB9LFxyXG5cdCcvYXBwL2xhZGRlci9wb3N0L3ZpbmVnYXInOiB7IHV1aWQ6IHV1aWQgfSxcclxufVxyXG5cclxuaW50ZXJmYWNlIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcCB7XHJcblx0Jy90b3BpYy9jaGF0LyRsYWRkZXJOdW0nOiBTb2NrZXRDaGF0TWVzc2FnZSxcclxuXHQnL3RvcGljL2xhZGRlci8kbGFkZGVyTnVtJzogeyBldmVudHM6IFNvY2tldExhZGRlckV2ZW50W10sIHNlY29uZHNQYXNzZWQ6IG51bWJlciB9LFxyXG5cdCcvdXNlci9xdWV1ZS9hY2NvdW50L2xvZ2luJzoge1xyXG5cdFx0c3RhdHVzOiAnT0snIHwgJ0NSRUFURUQnIHwgJz8nLFxyXG5cdFx0Y29udGVudDoge1xyXG5cdFx0XHR1dWlkOiB1dWlkLCBhY2NvdW50SWQ6IG51bWJlciwgaGlnaGVzdEN1cnJlbnRMYWRkZXI6IG51bWJlcixcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9jaGF0Lyc6IHtcclxuXHRcdHN0YXR1czogJ09LJyB8ICc/JyxcclxuXHRcdGNvbnRlbnQ6IHtcclxuXHRcdFx0Y3VycmVudENoYXROdW1iZXI6IG51bWJlcixcclxuXHRcdFx0bWVzc2FnZXM6IFNvY2tldENoYXRNZXNzYWdlW10sXHJcblx0XHR9XHJcblx0fSxcclxuXHQnL3VzZXIvcXVldWUvaW5mbyc6IHtcclxuXHRcdGFzc2hvbGVMYWRkZXI6IG51bWJlcixcclxuXHRcdGFzc2hvbGVUYWdzOiBzdHJpbmdbXSxcclxuXHRcdGF1dG9Qcm9tb3RlTGFkZGVyOiBudW1iZXIsXHJcblx0XHRiYXNlR3JhcGVzTmVlZGVkVG9BdXRvUHJvbW90ZTogRGVjaW1hbFN0cmluZyxcclxuXHRcdGJhc2VWaW5lZ2FyTmVlZGVkVG9UaHJvdzogRGVjaW1hbFN0cmluZyxcclxuXHRcdG1hbnVhbFByb21vdGVXYWl0VGltZTogbnVtYmVyLFxyXG5cdFx0bWluaW11bVBlb3BsZUZvclByb21vdGU6IG51bWJlcixcclxuXHRcdHBvaW50c0ZvclByb21vdGU6IERlY2ltYWxTdHJpbmcsXHJcblx0fSxcclxuXHQnL3VzZXIvcXVldWUvbGFkZGVyLyc6IHtcclxuXHRcdHN0YXR1czogJ09LJyB8ICc/JyxcclxuXHRcdGNvbnRlbnQ6IHtcclxuXHRcdFx0Y3VycmVudExhZGRlcjogeyBudW1iZXI6IG51bWJlciB9LFxyXG5cdFx0XHRmaXJzdFJhbmtlcjogU29ja2V0UmFua2VyLFxyXG5cdFx0XHR5b3VyUmFua2VyOiBTb2NrZXRZb3VSYW5rZXIsXHJcblx0XHRcdHJhbmtlcnM6IFNvY2tldFJhbmtlcltdLFxyXG5cdFx0XHRzdGFydFJhbms6IG51bWJlcixcclxuXHRcdH1cclxuXHR9LFxyXG5cdCcvdXNlci9xdWV1ZS9sYWRkZXIvdXBkYXRlcyc6IHtcclxuXHRcdGV2ZW50czogU29ja2V0TGFkZGVyRXZlbnRbXSxcclxuXHR9LFxyXG59XHJcblxyXG5jbGFzcyBGYWlyU29ja2V0IHtcclxuXHRzdG9tcENsaWVudDogU3RvbXBKcy5Db21wYXRDbGllbnQ7XHJcblx0dXNlckRhdGEgPSBuZXcgVXNlckRhdGEoKTtcclxuXHRzdGF0ZSA9IFZ1ZS5yZWFjdGl2ZSh7XHJcblx0XHRjb25uZWN0ZWQ6IGZhbHNlLFxyXG5cdFx0Y29ubmVjdGlvblJlcXVlc3RlZDogZmFsc2UsXHJcblx0fSk7XHJcblx0Y29uc3RydWN0b3IoKSB7XHJcblx0XHR0aGlzLnN0b21wQ2xpZW50ID0gU3RvbXBKcy5TdG9tcC5vdmVyKCgpID0+IG5ldyBTb2NrSlMoJ2h0dHBzOi8vZmFpci5rYWxpYnVyZy5kZS9mYWlyc29ja2V0JykpO1xyXG5cdFx0aWYgKCFsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvbXBDbGllbnQuZGVidWcnKSkge1xyXG5cdFx0XHR0aGlzLnN0b21wQ2xpZW50LmRlYnVnID0gKCkgPT4geyB9O1xyXG5cdFx0fVxyXG5cdFx0Zm9yIChsZXQgayBvZiBbXHJcblx0XHRcdCdvbkNoYW5nZVN0YXRlJyxcclxuXHRcdFx0J29uQ29ubmVjdCcsXHJcblx0XHRcdCdvbkRpc2Nvbm5lY3QnLFxyXG5cdFx0XHQnb25TdG9tcEVycm9yJyxcclxuXHRcdFx0J29uVW5oYW5kbGVkRnJhbWUnLFxyXG5cdFx0XHQnb25VbmhhbmRsZWRNZXNzYWdlJyxcclxuXHRcdFx0J29uVW5oYW5kbGVkUmVjZWlwdCcsXHJcblx0XHRcdCdvbldlYlNvY2tldENsb3NlJyxcclxuXHRcdFx0J29uV2ViU29ja2V0RXJyb3InLFxyXG5cdFx0XSBhcyBjb25zdCkge1xyXG5cdFx0XHQvLyBqdXN0IGxvZ2dpbmcgZXZlcnl0aGluZ1xyXG5cdFx0XHR0aGlzLnN0b21wQ2xpZW50W2tdID0gKC4uLmEpID0+IHtcclxuXHRcdFx0XHRpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N0b21wQ2xpZW50LmxvZ0V2ZW50cycpKVxyXG5cdFx0XHRcdFx0Y29uc29sZS53YXJuKGssIC4uLmEpO1xyXG5cdFx0XHRcdCh0aGlzIGFzIGFueSlba10/LiguLi5hKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29uYmVmb3JldW5sb2FkJywgKCkgPT4gdGhpcy5kaXNjb25uZWN0KCkpO1xyXG5cdH1cclxuXHRfcmVzb2x2ZU9uQ29ubmVjdGVkOiAoKCkgPT4gdm9pZClbXSA9IFtdO1xyXG5cdGNvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3Rpb25SZXF1ZXN0ZWQgPSB0cnVlO1xyXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG5cdFx0XHRpZiAodGhpcy5zdG9tcENsaWVudC5jb25uZWN0ZWQpIHtcclxuXHRcdFx0XHRyZXNvbHZlKCk7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0dGhpcy5fcmVzb2x2ZU9uQ29ubmVjdGVkLnB1c2gocmVzb2x2ZSk7XHJcblx0XHRcdFx0dGhpcy5zdG9tcENsaWVudC5jb25uZWN0KHt9LCB0aGlzLnN0b21wQ2xpZW50Lm9uQ29ubmVjdCk7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxuXHRkaXNjb25uZWN0KCkge1xyXG5cdFx0dGhpcy5zdG9tcENsaWVudC5kaXNjb25uZWN0KCk7XHJcblx0XHR0aGlzLnN0YXRlLmNvbm5lY3Rpb25SZXF1ZXN0ZWQgPSBmYWxzZTtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGVkID0gZmFsc2U7XHJcblx0fVxyXG5cdG9uQ29ubmVjdCgpIHtcclxuXHRcdHRoaXMuc3RhdGUuY29ubmVjdGlvblJlcXVlc3RlZCA9IGZhbHNlO1xyXG5cdFx0dGhpcy5zdGF0ZS5jb25uZWN0ZWQgPSB0cnVlO1xyXG5cdFx0dGhpcy5fcmVzb2x2ZU9uQ29ubmVjdGVkLm1hcChlID0+IGUoKSk7XHJcblx0fVxyXG5cclxuXHRzZW5kPEsgZXh0ZW5kcyBFeHRyYWN0PGtleW9mIEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGRhdGE6IEZhaXJTb2NrZXRTZW5kUmVxdWVzdE1hcFtLXSwgbnVtYmVyOiBudW1iZXIpOiB2b2lkO1xyXG5cdHNlbmQ8SyBleHRlbmRzIEV4Y2x1ZGU8a2V5b2YgRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwLCBgJHtzdHJpbmd9JCR7c3RyaW5nfWA+PihkZXN0aW5hdGlvbjogSywgZGF0YTogRmFpclNvY2tldFNlbmRSZXF1ZXN0TWFwW0tdKTogdm9pZDtcclxuXHRzZW5kPEsgZXh0ZW5kcyBrZXlvZiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXA+KGRlc3RpbmF0aW9uOiBLLCBkYXRhOiBGYWlyU29ja2V0U2VuZFJlcXVlc3RNYXBbS10sIG51bWJlcj86IG51bWJlcikge1xyXG5cdFx0aWYgKGRlc3RpbmF0aW9uLmluY2x1ZGVzKCckJykpIHtcclxuXHRcdFx0aWYgKG51bWJlciA9PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignYmFkIHVzYWdlJyk7XHJcblx0XHRcdGRlc3RpbmF0aW9uID0gYCR7ZGVzdGluYXRpb24uc3BsaXQoJyQnKVswXX0ke251bWJlcn1gIGFzIGFueTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGlmIChudW1iZXIgIT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0fVxyXG5cdFx0dGhpcy5zdG9tcENsaWVudC5zZW5kKGRlc3RpbmF0aW9uLCB7fSwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG5cdH1cclxuXHRzdWJzY3JpYmU8SyBleHRlbmRzIEV4dHJhY3Q8a2V5b2YgRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwLCBgJHtzdHJpbmd9JCR7c3RyaW5nfWA+PihkZXN0aW5hdGlvbjogSywgbGlzdGVuZXI6IChkYXRhOiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXBbS10pID0+IHZvaWQsIHJlcXVlc3Q6IHsgdXVpZDogdXVpZCB9LCBudW1iZXI6IG51bWJlcik6IFN0b21wSnMuU3RvbXBTdWJzY3JpcHRpb247XHJcblx0c3Vic2NyaWJlPEsgZXh0ZW5kcyBFeGNsdWRlPGtleW9mIEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcCwgYCR7c3RyaW5nfSQke3N0cmluZ31gPj4oZGVzdGluYXRpb246IEssIGxpc3RlbmVyOiAoZGF0YTogRmFpclNvY2tldFN1YnNjcmliZVJlc3BvbnNlTWFwW0tdKSA9PiB2b2lkLCByZXF1ZXN0OiB7IHV1aWQ6IHV1aWQgfSk6IFN0b21wSnMuU3RvbXBTdWJzY3JpcHRpb247XHJcblx0c3Vic2NyaWJlPEsgZXh0ZW5kcyBrZXlvZiBGYWlyU29ja2V0U3Vic2NyaWJlUmVzcG9uc2VNYXA+KGRlc3RpbmF0aW9uOiBLLCBsaXN0ZW5lcjogKGRhdGE6IEZhaXJTb2NrZXRTdWJzY3JpYmVSZXNwb25zZU1hcFtLXSkgPT4gdm9pZCwgcmVxdWVzdDogeyB1dWlkOiB1dWlkIH0sIG51bWJlcj86IG51bWJlcikge1xyXG5cdFx0aWYgKGRlc3RpbmF0aW9uLmluY2x1ZGVzKCckJykpIHtcclxuXHRcdFx0aWYgKG51bWJlciA9PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignYmFkIHVzYWdlJyk7XHJcblx0XHRcdGRlc3RpbmF0aW9uID0gYCR7ZGVzdGluYXRpb24uc3BsaXQoJyQnKVswXX0ke251bWJlcn1gIGFzIGFueTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGlmIChudW1iZXIgIT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ2JhZCB1c2FnZScpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIHRoaXMuc3RvbXBDbGllbnQuc3Vic2NyaWJlKGRlc3RpbmF0aW9uLCAobWVzc2FnZSkgPT4ge1xyXG5cdFx0XHRsZXQgZGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZS5ib2R5IHx8ICdudWxsJyk7XHJcblx0XHRcdGNvbnNvbGUud2FybihkZXN0aW5hdGlvbiwgZGF0YSwgbWVzc2FnZSk7XHJcblx0XHRcdGxpc3RlbmVyKGRhdGEpO1xyXG5cdFx0fSwgcmVxdWVzdCk7XHJcblx0fVxyXG59XHJcbiJdfQ==